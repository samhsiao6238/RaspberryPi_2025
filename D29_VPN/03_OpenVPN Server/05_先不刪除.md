# OpenVPN Server

## 準備樹莓派環境

1. 更新系統

   ```bash
   sudo apt update && sudo apt upgrade -y
   ```
2. 安裝必要工具

   ```bash
   sudo apt install -y openvpn easy-rsa
   ```

## 建立 OpenVPN 伺服器

1. 建立 Easy-RSA 檔案夾

   ```bash
   make-cadir ~/openvpn-ca
   cd ~/openvpn-ca
   ```
2. 配置變數，編輯 `vars` 檔案，並修改如下參數。

   ```bash
   nano vars
   ```

   修改以下內容：

   ```bash
   export KEY_COUNTRY="TW"
   export KEY_PROVINCE="TW"
   export KEY_CITY="Taipei"
   export KEY_ORG="MyVPN"
   export KEY_EMAIL="admin@example.com"
   export KEY_OU="MyVPN"
   export KEY_NAME="server"
   ```
3. 建立 CA（Certificate Authority）

   ```bash
   source vars
   ./clean-all
   ./build-ca
   ```
4. 建立伺服器憑證和金鑰

   ```bash
   ./build-key-server server
   ```
5. 建立 Diffie-Hellman 金鑰

   ```bash
   ./build-dh
   ```
6. 建立 TLS 金鑰

   ```bash
   openvpn --genkey --secret keys/ta.key
   ```

## 配置 OpenVPN 伺服器

1. 複製樣本配置檔

   ```bash
   sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz /etc/openvpn/
   sudo gzip -d /etc/openvpn/server.conf.gz
   ```
2. 修改伺服器配置，編輯 `/etc/openvpn/server.conf`。

   ```bash
   sudo nano /etc/openvpn/server.conf
   ```
3. 確保包含以下內容

   ```bash
   port 1194
   proto udp
   dev tun
   ca ca.crt
   cert server.crt
   key server.key
   dh dh.pem
   auth SHA256
   tls-auth ta.key 0
   cipher AES-256-CBC
   user nobody
   group nogroup
   persist-key
   persist-tun
   push "redirect-gateway def1 bypass-dhcp"
   push "dhcp-option DNS 8.8.8.8"
   push "dhcp-option DNS 8.8.4.4"
   ```
4. 複製生成的憑證和金鑰

   ```bash
   sudo cp ~/openvpn-ca/keys/{server.crt,server.key,ca.crt,dh.pem,ta.key} /etc/openvpn/
   ```

## 啟動 OpenVPN 伺服器

1. 啟動服務

   ```bash
   sudo systemctl start openvpn@server
   sudo systemctl enable openvpn@server
   ```
2. 檢查伺服器狀態

   ```bash
   sudo systemctl status openvpn@server
   ```

## 設置防火牆

1. 開啟 IP 轉發

   ```bash
   sudo sysctl -w net.ipv4.ip_forward=1
   ```
2. 永久啟用

   ```bash
   sudo nano /etc/sysctl.conf
   ```
3. 添加或取消註解

   ```bash
   net.ipv4.ip_forward=1
   ```
4. 配置 iptables

   ```bash
   sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
   sudo iptables-save | sudo tee /etc/iptables/rules.v4
   ```

## 生成用戶配置檔案

1. 建立用戶憑證

   ```bash
   cd ~/openvpn-ca
   source vars
   ./build-key client1
   ```
2. 生成客戶端配置檔，在 `/etc/openvpn/client/` 建立 `client.ovpn`。

   ```bash
   nano ~/client.ovpn
   ```
3. 配置如下

   ```bash
   client
   dev tun
   proto udp
   remote <RaspberryPi_IP> 1194
   resolv-retry infinite
   nobind
   persist-key
   persist-tun
   ca ca.crt
   cert client1.crt
   key client1.key
   auth SHA256
   tls-auth ta.key 1
   cipher AES-256-CBC
   ```
4. 將客戶端配置檔與憑證匯出，將 `client.ovpn` 和相關憑證 (`ca.crt`, `client1.crt`, `client1.key`, `ta.key`) 匯出到用戶設備。

## 客戶端連接

1. 將 `client.ovpn` 匯入到 OpenVPN 客戶端，啟動連線，即可使用樹莓派架設的 VPN 伺服器。
