# DD-WRT OpenVPN 伺服器設定指南

_使用 `Buffalo WZR-HP-G450H`，先確認是否已安裝 `DD-WRT`，接著進行安裝並設定 OpenVPN 伺服器，確保您可以遠端連線進入內部網路。_

## dd-wrt

1. 訪問 [官網](https://dd-wrt.com/)，點擊上方 `DOWNLOADS` 頁籤。

2. 輸入 `Buffalo` 設備型號 `WZR-HP-G450H` 搜尋。

3. 點擊進入會顯示可下載項目。

## 設定 OpenVPN 伺服器

1. 啟用 OpenVPN Server，在 `Services` → `VPN`。

2. `OpenVPN Server/Daemon` → `Enable`

3. `CVE-2019-14899 Mitigation` → `Enable`

4. `Start Type` → `WAN Up`；確保 VPN 在網路啟動時自動啟動。

5. `Inbound Firewall on TUN` → 打勾 ✅，確保 TUN 介面流量可通過。

## 伺服器基本設定

1. `Config as` → `Server`，打勾 ✅ 啟用伺服器模式。

2. `Server mode` → `Router (TUN)`，打勾 ✅ 使用 `TUN` 模式，確保 VPN 是路由模式。

3. Network → `10.8.0.0`

4. Netmask → `255.255.255.0`，這代表 OpenVPN 使用 `10.8.0.0/24` 作為 VPN 內部網路，請保持預設值。

5. Port → `1194`（UDP 預設 OpenVPN 連線埠）

6. Tunnel Protocol → `UDP`；建議使用 `UDP`，若有防火牆限制可改 `TCP`，若使用 TCP，可能會增加連線延遲，但某些網路環境如公司防火牆可能只允許 TCP。

7. Encryption Cipher → `AES-256-CBC`；這是高安全性加密。

8. Hash Algorithm → `SHA256`；這是高安全性。


## 設定加密協定

1. First Data Cipher → `AES-128-GCM`

2. Second Data Cipher → `AES-256-GCM`

3. Third Data Cipher → `AES-128-CBC`

4. Advanced Options → `Disable`；先關閉進階設定。

5. Public Server Cert → `Disable`；這樣客戶端不需要手動驗證。

## CA 憑證與金鑰

_這些欄位需要填入 OpenVPN 伺服器憑證；如果還沒有，可在 Linux 或 Mac 上使用 EasyRSA 或 OpenVPN 工具來產生憑證_

1. 產生憑證，以下指令是在 Linux、macOS 或樹莓派執行。

```bash
cd /etc/openvpn/
openvpn --genkey --secret ta.key
```

## 填入憑證

1. CA Cert，CA 憑證貼上 `ca.crt` 內容。

```bash
--BEGIN CERTIFICATE--
(CA 憑證內容)
--END CERTIFICATE--
```

2. Private Server Key，伺服器金鑰貼上 `server.key` 內容。

```bash
--BEGIN PRIVATE KEY--
(私鑰內容)
--END PRIVATE KEY--
```

3. DH PEM → `Enable`，啟用 DH 金鑰，貼上 `dh.pem`。

```bash
--BEGIN DH PARAMETERS--
(DH 參數內容)
--END DH PARAMETERS--
```

## 設定 TLS

1. TLS Key Choice → `TLS Auth`，選擇 TLS Auth

2. TLS Key，填入 `ta.key`

```bash
--BEGIN OpenVPN Static Key V1--
(TLS 密鑰內容)
--END OpenVPN Static Key V1--
```

3. Certificate Revoke List，留空，若有需要可填入 `crl.pem`。

## 允許 VPN 連線流量

_設定防火牆；確保 VPN 連線的流量可以通過 DD-WRT 路由器，執行以下防火牆設定_

1. 進入 DD-WRT 管理頁面，`Administration` → `Commands`

2. 貼上命令。

```bash
iptables -I INPUT -p udp --dport 1194 -j ACCEPT
iptables -I FORWARD -s 10.8.0.0/24 -j ACCEPT
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o br0 -j MASQUERADE
```

3. 點擊 Save Firewall；儲存防火牆規則。

4. 重啟路由器

## OpenVPN 客戶端設定

1. 在電腦或手機上 使用 OpenVPN 客戶端，並建立 `.ovpn` 設定檔

```ini
client
dev tun
proto udp
remote YOUR_PUBLIC_IP 1194
resolv-retry infinite
nobind
persist-key
persist-tun
cipher AES-256-CBC
auth SHA256
tls-client
remote-cert-tls server
verb 3

<ca>
--BEGIN CERTIFICATE--
(CA 憑證內容)
--END CERTIFICATE--
</ca>

<cert>
--BEGIN CERTIFICATE--
(客戶端憑證)
--END CERTIFICATE--
</cert>

<key>
--BEGIN PRIVATE KEY--
(客戶端私鑰)
--END PRIVATE KEY--
</key>

<tls-auth>
--BEGIN OpenVPN Static Key V1--
(TLS 密鑰內容)
--END OpenVPN Static Key V1--
</tls-auth>
```

2. 將此 `.ovpn` 檔案匯入 OpenVPN Connect 或 Tunnelblick，然後測試連線。

## 測試 VPN 連線

1. 確認 OpenVPN 伺服器已啟動，在 DD-WRT 介面確認 「VPN狀態」 顯示為 Running，接著在 SSH/Telnet 測試。

```bash
ps | grep openvpn
```

2. 使用客戶端連線

3. 確認 VPN IP

```bash
curl ifconfig.me
```
