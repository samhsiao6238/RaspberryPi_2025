# 設置路由為客戶端

_在 DD-WRT 設定 OpenVPN 作為客戶端_

## 準備工作

1. 無論是使用商業 VPN 如 NordVPN、ExpressVPN、Surfshark，或是第三方提供的免費服務，皆先取得服務商提供的 OpenVPN 設定檔 (`.ovpn`)。

2. 接著登入路由器 `DD-WRT`，進入頁籤 `Services → VPN`。

3. 將 `OpenVPN Client` 第一項 `Start OpenVPN Client` 開啟為 `Enable`。

![](images/img_05.png)

## 開始設定

1. 將 `Server IP/Name` 設定為 VPN 伺服器網域或 IP，這裡設定為 IP `219.100.37.18`。

2. Port `1194`。

3. Tunnel Device 設定為 `TUN`

4. Tunnel Protocol 依 VPN 服務商要求設定，`UDP` 或 `TCP` 皆有。

5. Encryption Cipher 設定為 `AES-256-CBC`。

6. Hash Algorithm 設定為 `SHA256`。

7. User Pass Authentication 設定為 `Enable`。

8. Username 及 Password 分別設定為 `VPN帳號` 及 `VPN密碼`。

## 憑證與密鑰

_在 `VPN Client` 設定中，有幾個欄位需要填入 `.ovpn` 檔案中的憑證內容_

1. CA Cert (`ca.crt`) 貼上 `<ca> ... </ca>` 內容

```txt
--BEGIN CERTIFICATE--
(貼上 `ca.crt` 內容)
--END CERTIFICATE--
```

2. Public Client Cert (`client.crt`) 貼上 `<cert> ... </cert>` 內容

```txt
--BEGIN CERTIFICATE--
(貼上 `client.crt` 內容)
--END CERTIFICATE--
```

3. Private Client Key (`client.key`) 貼上 `<key> ... </key>` 內容

```txt
--BEGIN PRIVATE KEY--
(貼上 `client.key` 內容)
--END PRIVATE KEY--
```

4. TLS Auth Key 部分，如果 `.ovpn` 檔案內有 `<tls-auth> ... </tls-auth>`，則貼上。

```txt
--BEGIN OpenVPN Static Key V1--
(貼上 `ta.key` 內容)
--END OpenVPN Static Key V1--
```

5. 如果 VPN 伺服器沒有 TLS 認證金鑰 (`ta.key`)，務必確保 `TLS Cipher` 設定為 `None`。

## 設定 DNS

_用以避免 DNS 洩漏_

1. 進入 `Setup → Basic Setup`

2. 在 `Network Setup` 中找到 `Static DNS`

```bash
DNS 1 → `10.234.254.254`
DNS 2 → `8.8.8.8`（Google DNS）
DNS 3 → `1.1.1.1`（Cloudflare DNS）
```
![](images/img_06.png)

3. 勾選 `Forced DNS Redirection`

4. 點擊 `Save`，然後 `Apply Settings`

## 確保 VPN 連線時所有設備都經過 VPN

1. 在 `Services` 中的 `VPN`，設定 `Additional Config` 欄位，加入以下內容。

```bash
# 避免 VPN 伺服器強制改變您的路由
route-nopull
# 讓所有網路流量都經過 VPN
redirect-gateway def1
# 避免伺服器過快判斷掉線
keepalive 10 120
# 啟用伺服器證書驗證避免中間攻擊
remote-cert-tls server
# 明確關閉 LZO 壓縮
comp-lzo no
```

## 防火牆規則

_如果 VPN 連線後無法正常上網，嘗試加入防火牆規則_

1. 進入 `Administration → Commands`

2. 輸入以下命令，並點擊 `Run Commands`

```bash
iptables -I INPUT -p tcp --dport 443 -j ACCEPT
iptables -I INPUT -p udp --dport 1194 -j ACCEPT
iptables -I FORWARD -i tun1 -o br0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -I FORWARD -i br0 -o tun1 -j ACCEPT
iptables -t nat -A POSTROUTING -o tun1 -j MASQUERADE
```

3. 點擊 `Save Firewall`，然後 `Apply Settings`。

## 重啟路由器

_可透過終端機指令進行_

1. 連線。

```bash
ssh root@192.168.11.1
```

2. 重啟。

```bash
reboot
```

## 測試 VPN 是否正常運作

1. 進入 `Status → OpenVPN` 查看 `State` 是否顯示 `Connected`，如果未連線，請查看 `Log` 找出錯誤訊息。

![](images/img_07.png)

2. 在連線 VPN 前後街開啟瀏覽器訪問並查看 IP 變化。

```bash
https://www.whatismyip.com/
```
