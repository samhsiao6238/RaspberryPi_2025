# å®‰è£ä¸¦é…ç½® OpenVPN

## åŸºæœ¬å»ºç½®

1. æ›´æ–°ã€‚

```bash
sudo apt update && sudo apt upgrade -y
```

2. å®‰è£ã€‚

```bash
sudo apt install -y openvpn
```

3. å‡ºç¾ `Daemons using outdated libraries` æç¤ºï¼Œé€™æ˜¯å› ç‚ºç³»çµ±ç™¼ç¾æŸäº›é‹è¡Œä¸­çš„æœå‹™ä½¿ç”¨äº†èˆŠç‰ˆæœ¬çš„åº«ï¼Œéœ€è¦é‡æ–°å•Ÿå‹•æ‰èƒ½ç”Ÿæ•ˆï¼Œé»æ“Š `OK`ã€‚

![](images/img_07.png)

4. å®‰è£ã€‚

```bash
sudo apt update
sudo apt install --only-upgrade cloud-init
sudo apt install -y easy-rsa
```

5. ç¢ºèª easy-rsa å®‰è£è·¯å¾‘ã€‚

```bash
ls /usr/share/easy-rsa/
ls /usr/share/doc/easy-rsa/
```

6. å®‰è£

```bash
sudo apt install openvpn -y
```

## å»ºç«‹ OpenVPN ä¼ºæœå™¨

1. å»ºç«‹ OpenVPN ç›®éŒ„ã€‚

```bash
mkdir -p ~/openvpn-ca && cd ~/openvpn-ca
```

2. è¤‡è£½ã€‚

```bash
cp -r /usr/share/easy-rsa/* ~/openvpn-ca/
```

3. åˆå§‹åŒ– CAã€‚

```bash
./easyrsa init-pki
```

![](images/img_08.png)

4. å»ºç«‹ CAï¼Œå‡ºç¾æç¤ºæ™‚ç›´æ¥æŒ‰ Enter å³å¯ã€‚

```bash
./easyrsa build-ca nopass
```

## ç”Ÿæˆä¼ºæœå™¨è­‰æ›¸å’Œç§é‘°

1. ç”Ÿæˆä¼ºæœå™¨è«‹æ±‚æ–‡ä»¶ï¼Œé€™æœƒå»ºç«‹ server.key å’Œ server.reqï¼Œæç¤ºè¼¸å…¥åç¨±æ™‚é»æ“Š `ENTER` å³å¯ã€‚

```bash
./easyrsa gen-req server nopass
```

2. ç°½ç½²ä¼ºæœå™¨è­‰æ›¸

```bash
./easyrsa sign-req server server
```

3. æç¤º `Type the word 'yes' to continue` æ™‚è¼¸å…¥ `yes` å³å¯ã€‚


4. ç”Ÿæˆ `DH` å¯†é‘°

```bash
./easyrsa gen-dh
```

5. ç”Ÿæˆ `TLS` é‡‘é‘°

```bash
openvpn --genkey secret ta.key
```

6. é‡æ–°è¤‡è£½æ‰€æœ‰æ†‘è­‰èˆ‡å¯†é‘°åˆ° /etc/openvpn/

```bash
sudo cp ~/openvpn-ca/pki/ca.crt /etc/openvpn/
sudo cp ~/openvpn-ca/pki/issued/server.crt /etc/openvpn/
sudo cp ~/openvpn-ca/pki/private/server.key /etc/openvpn/
sudo cp ~/openvpn-ca/pki/dh.pem /etc/openvpn/
sudo cp ~/openvpn-ca/ta.key /etc/openvpn/
```

7. ç¢ºèª

```bash
ls -l /etc/openvpn/
```

## é…ç½® OpenVPN

1. å»ºç«‹ä¼ºæœå™¨é…ç½®

```bash
sudo nano /etc/openvpn/server.conf
```

2. æª¢æŸ¥ã€‚

```bash
ls /etc/openvpn/
```

3. è²¼ä¸Šä»¥ä¸‹å…§å®¹ï¼Œå„²å­˜ä¸¦é€€å‡ºã€‚

```ini
port 1194
proto udp
dev tun
ca /etc/openvpn/ca.crt
cert /etc/openvpn/server.crt
key /etc/openvpn/server.key
dh /etc/openvpn/dh.pem
tls-crypt /etc/openvpn/ta.key
server 10.8.0.0 255.255.255.0
topology subnet
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
keepalive 10 120
cipher AES-256-CBC
auth SHA256
user nobody
group nogroup
persist-key
persist-tun
status /var/log/openvpn/status.log
log /var/log/openvpn/openvpn.log
verb 3
explicit-exit-notify 1
```

4. å•Ÿç”¨ OpenVPN

```bash
sudo systemctl enable openvpn@server
sudo systemctl start openvpn@server
sudo systemctl status openvpn@server
```

5. æŸ¥çœ‹æ—¥èªŒã€‚

```bash
sudo journalctl -u openvpn@server --no-pager -n 50
```

6. æª¢æŸ¥ OpenVPN è¨­å®šæª”æ˜¯å¦æœ‰éŒ¯èª¤

```bash
sudo openvpn --config /etc/openvpn/server.conf --verb 4
```

7. é‡æ–°å•Ÿå‹• OpenVPN

```bash
sudo systemctl restart openvpn@server
sudo systemctl status openvpn@server
```

8. ç¢ºä¿ OpenVPN ç›£è½ 1194 ç«¯å£

```bash
sudo netstat -tulnp | grep openvpn
```


## è¨­å®šé˜²ç«ç‰†èˆ‡ NAT

1. é–‹å•Ÿ 1194 UDP ç«¯å£

```bash
sudo ufw allow 1194/udp
```

2. å•Ÿç”¨ IP è½‰ç™¼

```bash
sudo nano /etc/sysctl.conf
```

3. æ·»åŠ 

```bash
net.ipv4.ip_forward=1
```

4. å„²å­˜ä¸¦é€€å‡ºï¼Œç„¶å¾ŒåŸ·è¡Œ

```bash
sudo sysctl -p
```

5. è¨­å®š NATï¼Œè¼¸å…¥ `y`

```bash
sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
sudo ufw allow OpenSSH
sudo ufw enable
sudo systemctl restart openvpn@server
```


## å»ºç«‹ç”¨æˆ¶è­‰æ›¸

1. ç”Ÿæˆå®¢æˆ¶ç«¯æ†‘è­‰

```bash
cd ~/openvpn-ca
./easyrsa gen-req client1 nopass
```

2. è¼¸å…¥ yes ä¾†ç¢ºèªç°½ç½²ã€‚

```bash
./easyrsa sign-req client client1
```

## å»ºç«‹ OpenVPN å®¢æˆ¶ç«¯é…ç½®

1. æŸ¥è©¢

```bash
cat /root/openvpn-ca/pki/ca.crt
cat /root/openvpn-ca/pki/issued/client1.crt
cat /root/openvpn-ca/pki/private/client1.key
cat /root/openvpn-ca/ta.key
```

2. ç·¨è¼¯

```bash
sudo nano ~/openvpn-ca/client1.ovpn
```

3. è²¼ä¸Šä»¥ä¸‹å…§å®¹

```bash
client
dev tun
proto udp
remote 118.31.77.245 1194
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
auth SHA256
data-ciphers AES-256-GCM:AES-128-GCM:AES-256-CBC
data-ciphers-fallback AES-256-CBC
tls-crypt ta.key
verb 3
<ca>
# é€™è£¡è²¼ä¸Š `ca.crt` å…§å®¹
</ca>
<cert>
# é€™è£¡è²¼ä¸Š `client1.crt` å…§å®¹
</cert>
<key>
# é€™è£¡è²¼ä¸Š `client1.key` å…§å®¹
</key>
<tls-crypt>
# é€™è£¡è²¼ä¸Š `ta.key` å…§å®¹
</tls-crypt>
```

## ä¸‹è¼‰å®¢æˆ¶ç«¯é…ç½®

1. åœ¨æœ¬åœ°ä¸‹è¼‰ OpenVPN è¨­å®š

```bash
scp ali:~/openvpn-ca/client1.ovpn ~/Downloads/
```


## ä¿®æ­£é ç«¯

1. ç·¨è¼¯

```bash
sudo nano /etc/openvpn/server.conf
```

2. å…§å®¹

```bash
port 1194
proto udp
dev tun

ca /etc/openvpn/ca.crt
cert /etc/openvpn/server.crt
key /etc/openvpn/server.key
dh /etc/openvpn/dh.pem
tls-crypt /etc/openvpn/ta.key

server 10.8.0.0 255.255.255.0
topology subnet
ifconfig-pool-persist /var/log/openvpn/ipp.txt

push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"

keepalive 10 120
user nobody
group nogroup
persist-key
persist-tun

status /var/log/openvpn/status.log
log /var/log/openvpn/openvpn.log
verb 3
explicit-exit-notify 1

# é©ç”¨æ–¼ OpenVPN 2.5+
data-ciphers AES-256-GCM:AES-128-GCM:AES-256-CBC
data-ciphers-fallback AES-256-CBC
```


3. å¥—ç”¨æ›´æ”¹ä¸¦é‡å•Ÿ OpenVPN

```bash
sudo systemctl restart openvpn@server
sudo systemctl status openvpn@server
```

4. ä¿®æ­£ iptables FORWARD è¨­å®šï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ä¾†å…è¨± VPN è½‰ç™¼

```bash
sudo iptables -A FORWARD -s 10.8.0.0/24 -j ACCEPT
sudo iptables -A FORWARD -d 10.8.0.0/24 -j ACCEPT
```

5. ç¢ºèªä¸»è¦å¤–éƒ¨ç¶²å¡åç¨±

```bash
ip route | grep default
```

6. ç„¶å¾ŒåŸ·è¡Œ NAT è¦å‰‡ï¼Œå°‡ `eth0` æ›´æ”¹ç‚ºç¶²å¡åç¨±

```bash
sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
```

7. ç¢ºä¿ NAT è¦å‰‡æ°¸ä¹…ç”Ÿæ•ˆ

```bash
sudo iptables-save | sudo tee /etc/iptables/rules.v4
```

8. é‡å•Ÿ OpenVPN èˆ‡ é˜²ç«ç‰†

```bash
sudo systemctl restart openvpn@server
sudo systemctl restart ufw
```

9. åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ä¾†å…è¨± OpenVPN è½‰ç™¼ï¼Œè¼¸å…¥ `y`

```bash
sudo ufw allow 1194/udp
sudo ufw allow OpenSSH
sudo ufw allow in on tun0
sudo ufw allow out on tun0
sudo ufw enable
```

10. ç·¨è¼¯ ufw é è¨­è¦å‰‡ ä¾†å…è¨±è½‰ç™¼

```bash
sudo nano /etc/default/ufw
```

11. å°‡é è¨­çš„ `DROP` æ”¹ç‚º `ACCEPT` 

```bash
DEFAULT_FORWARD_POLICY="ACCEPT"
```

12. é‡å•Ÿé˜²ç«ç‰†

```bash
sudo systemctl restart ufw
```

13. ç¢ºèª iptables -L FORWARD -v -n æ˜¯å¦æœ‰å°åŒ…æµé‡

```bash
sudo iptables -L FORWARD -v -n
```

## æœ¬åœ°é›»è…¦é€£æ¥ OpenVPN




### ğŸš€ æœ€çµ‚æ¸¬è©¦
1. æ¸¬è©¦ VPN æ˜¯å¦æˆåŠŸç¿»ç‰†
   ```bash
   curl ifconfig.me
   ```
   é€™å€‹æ‡‰è©²è¿”å› é˜¿é‡Œäº‘ ECS å…¬ç¶² IPï¼Œè­‰æ˜æ‰€æœ‰æµé‡é€šé VPNã€‚

2. æ¸¬è©¦èƒ½å¦æ­£å¸¸è¨ªå• Google
   - æ‰“é–‹ç€è¦½å™¨ï¼Œå˜—è©¦è¨ªå• Google
   - å¦‚æœèƒ½æ‰“é–‹ï¼Œå‰‡ç¿»ç‰†æˆåŠŸï¼



## ğŸ¯ ç¸½çµ
1. å®‰è£ OpenVPN
2. å»ºç«‹ä¼ºæœå™¨èˆ‡å®¢æˆ¶ç«¯è­‰æ›¸
3. é…ç½® OpenVPN ä¼ºæœå™¨
4. è¨­å®š NAT è½‰ç™¼èˆ‡é˜²ç«ç‰†
5. ç”Ÿæˆå®¢æˆ¶ç«¯é…ç½®ä¸¦ä¸‹è¼‰
6. æœ¬åœ°å°å…¥ OpenVPN é…ç½®ï¼ŒæˆåŠŸç¿»ç‰†ï¼

é€™æ¨£ï¼Œä½ çš„ Ubuntu ECS ä¼ºæœå™¨ ç¾åœ¨å°±æ˜¯ ä¸€å°å¯ç”¨çš„ OpenVPN ç¿»ç‰†ä¼ºæœå™¨ äº†ï¼ğŸ‰

è«‹æ¸¬è©¦ä¸¦å›å ±çµæœï¼ğŸš€