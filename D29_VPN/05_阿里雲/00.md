# 阿里雲

_[參考](https://www.gaoyufu.cn/archives/openvpn)_

##

## 在 ECS 上建立 OpenVPN 伺服器

1. 安裝必要軟體
```bash
yum -y install epel-release
yum update
yum -y install openvpn easy-rsa iptables-services openvpn-auth-ldap
```

### 2.2 產生 CA 憑證
『`bash
mkdir -p /etc/openvpn/easy-rsa/
cp -a /usr/share/easy-rsa/3/* /etc/openvpn/easy-rsa/
cp -a /usr/share/doc/easy-rsa-3.0.8/vars.example /etc/openvpn/easy-rsa/vars
cd /etc/openvpn/easy-rsa
./easyrsa init-pki
./easyrsa build-ca
```

### 2.3 產生伺服器憑證
『`bash
./easyrsa gen-req server nopass
./easyrsa sign server server
```

### 2.4 產生 Diffie-Hellman 和 TLS-Auth 金鑰
『`bash
./easyrsa gen-dh
openvpn --genkey --secret ta.key
```

### 2.5 產生客戶端憑證
『`bash
./easyrsa gen-req client nopass
./easyrsa sign client client
```



## 3. OpenVPN 伺服器端設定
### 3.1 設定 OpenVPN
建立 /etc/openvpn/server.conf 並寫入：
```ini
port 1194
proto udp
dev tun
server 10.106.0.0 255.255.255.0
push "route 192.168.0.0 255.255.255.0"
push "dhcp-option DNS 223.5.5.5"
keepalive 10 300
cipher AES-256-CBC
tls-crypt /etc/openvpn/server/certs/ta.key
ca /etc/openvpn/server/certs/ca.crt
cert /etc/openvpn/server/certs/server.crt
key /etc/openvpn/server/certs/server.key
dh /etc/openvpn/server/certs/dh.pem
log-append /var/log/openvpn/server.log
status /var/log/openvpn/status.log
explicit-exit-notify 1
```

### 3.2 設定防火牆
『`bash
systemctl stop firewalld
systemctl mask firewalld
systemctl enable iptables
systemctl start iptables
iptables -t nat -A POSTROUTING -s 10.106.0.0/24 -o eth0 -j MASQUERADE
echo net.ipv4.ip_forward = 1 >> /etc/sysctl.conf
sysctl -p
```

### 3.3 啟動 OpenVPN
『`bash
systemctl enable openvpn@server.service
systemctl start openvpn@server.service
systemctl status openvpn@server
```



## 4. OpenVPN 用戶端設定
建立客戶端設定檔 client.ovpn：
```ini
client
dev tun
proto udp
remote myvpnserver 1194
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
cipher AES-256-CBC
auth-user-pass
auth-nocache
script-security 3
key-direction 1
ca ca.crt
cert client.crt
key client.key
tls-crypt ta.key 1
```



## 5. 使用者管理
### 5.1 建立 OpenVPN 使用者
執行以下腳本 ovpn_user.sh 產生使用者：
『`bash
sh ovpn_user.sh testuser1
```
產生的 testuser1.zip 包含：
```
├── ca.crt
├── testuser1.crt
├── testuser1.key
├── testuser1.ovpn
└── ta.key
```
下載後導入 OpenVPN 用戶端即可。

### 5.2 刪除使用者
『`bash
sh del_ovpn_user.sh testuser1
```



## 6. OpenVPN 認證方式
### 6.1 預設方式
- 通過客戶端證書認證

### 6.2 MySQL 認證
- 配置資料庫
```sql
CREATE DATABASE openvpn DEFAULT CHARSET utf8;
USE openvpn;
CREATE TABLE vpnuser (name CHAR(100) NOT NULL, password CHAR(255) DEFAULT NULL, active INT(10) NOT NULL DEFAULT 1, PRIMARY KEY (name));
INSERT INTO vpnuser (name, password) VALUES ('test1', PASSWORD('123456'));
```
- 安裝 MySQL 認證外掛程式
『`bash
yum -y install pam_mysql
```
- 設定 PAM 認證
『`bash
cat > /etc/pam.d/openvpn_mysql << EOF
auth sufficient pam_mysql.so user=db_user passwd=db_pass host=db_host db=openvpn table=vpnuser usercolumn=name passwdcolumn=password where=active=1 crypt=2
account required pam_mysql.so user=db_user passwd=db_pass host=db_host db=openvpn table=vpnuser usercolumn=name passwdcolumn=password where=active=1 crypt=2
EOF
```
- OpenVPN 伺服器端設定
```ini
plugin /etc/openvpn/openvpn-plugin-auth-pam.so openvpn_mysql
```
- 驗證
『`bash
testsaslauthd -u test1 -p 123456 -s openvpn_mysql
```

### 6.3 LDAP 認證
- 設定 /etc/openvpn/auth/ldap.conf
```ini
<LDAP>
URL ldap://127.0.0.1:11389
BindDN cn=admin,dc=example,dc=com
Password 123456
</LDAP>
<Authorization>
BaseDN "ou=people,dc=example,dc=com"
SearchFilter "(&(cn=%u)(objectClass=person))"
</Authorization>
```
- 修改 OpenVPN 設定
```ini
plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so "/etc/openvpn/auth/ldap.conf"
```



## 7. 非全域代理模式
預設 OpenVPN 是全域代理，為避免影響辦公，可以使用 route-nopull 設定：
```ini
route-nopull
route 192.168.0.0 255.255.255.0 vpn_gateway
```
這樣，只有存取 192.168.0.0/24 網段才會走 VPN，其他流量仍走本地網路。



## 8. OpenVPN 內嵌設定
為了簡化用戶端配置，可將憑證、金鑰直接嵌入 .ovpn 檔案：
```ini
<ca>
--BEGIN CERTIFICATE--
…
--END CERTIFICATE--
</ca>
<cert>
…
</cert>
<key>
…
</key>
<tls-crypt>
…
</tls-crypt>
```



## 總結
- 優點：
 - 僅 VPN 內部能存取 Wiki，避免公網攻擊
 - 透過 OpenVPN 認證控制使用者存取權限
 - 支援多種認證方式（憑證、MySQL、LDAP）
 - 可設定 非全域代理，最佳化流量管理

- 適用場景：
 - 內網 Wiki 訪問
 - 企業遠距辦公
 - 需要內網穿透的應用場景

以上是 在阿里雲ECS上建立OpenVPN 伺服器 的完整指南，可用於 遠端存取、企業內網安全管理 等場景。