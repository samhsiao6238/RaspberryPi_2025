# 樹莓派熱點分享路由

## 更新並安裝必要軟體

1. 更新樹莓派系統

```bash
sudo apt update && sudo apt upgrade -y
```

2. 安裝相關工具

```bash
sudo apt install hostapd dnsmasq iptables-persistent -y
```

## HostAPD

_HostAPD 用於啟用 Wi-Fi 熱點功能_

1. 編輯主配置檔案 `/etc/hostapd/hostapd.conf`

```bash
sudo nano /etc/hostapd/hostapd.conf
```

2. 填入以下內容

```bash
interface=wlan0
driver=nl80211
ssid=PiHotspot
hw_mode=g
channel=7
wmm_enabled=1
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=11223344
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
```

## 配置 `hostapd` 預設文件

1. 編輯 `/etc/default/hostapd`

```bash
sudo nano /etc/default/hostapd
```

2. 添加以下內容

```bash
DAEMON_CONF="/etc/hostapd/hostapd.conf"
```

## 配置 Dnsmasq

_Dnsmasq 用於管理 DHCP 和 DNS_

1. 備份預設配置檔案

```bash
sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.bak
```

2. 建立新的配置檔案 `/etc/dnsmasq.conf`

```bash
sudo nano /etc/dnsmasq.conf
```

3. 填入以下內容

```bash
interface=wlan0
dhcp-range=192.168.50.10,192.168.50.50,12h
dhcp-option=3,192.168.50.1
dhcp-option=6,8.8.8.8,8.8.4.4
```

## 配置網卡靜態 IP

_新版系統不再使用 `/etc/dhcpcd.conf`，所以改用 `NetworkManager` 來設定網卡靜態 IP_

1. 列出所有網卡連線名稱

```bash
nmcli connection show
```

2. 找到 wlan0 所對應的連線名稱，假設連線名稱為 preconfigured，則將指令修正如下，用以設定靜態 IP 地址

```bash
sudo nmcli connection modify preconfigured ipv4.addresses 192.168.50.1/24
sudo nmcli connection modify preconfigured ipv4.gateway 192.168.50.1
sudo nmcli connection modify preconfigured ipv4.method manual
sudo nmcli connection up preconfigured
```

3. 完成後，確認靜態 IP 是否生效

```bash
ip addr show wlan0
```

## 配置 IP 轉發

1. 啟用內核 IP 轉發

```bash
sudo sysctl -w net.ipv4.ip_forward=1
```

2. 將其永久化，編輯 `/etc/sysctl.conf`

```bash
sudo nano /etc/sysctl.conf
```

3. 添加以下內容或取消預設的註解

```bash
net.ipv4.ip_forward=1
```

## 配置 NAT 網絡地址轉換

1. 確認有線網卡名稱

```bash
ip link show
```

2. 設置 iptables 規則以將流量轉發至有線網卡，一般是 `eth0`

```bash
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo netfilter-persistent save
```

3. 驗證規則是否正確設定

```bash
sudo iptables -t nat -L
sudo iptables -L
```

## 啟動服務

1. 解除屏蔽並啟用 `hostapd` 和 `dnsmasq`

```bash
sudo systemctl unmask hostapd
sudo systemctl enable hostapd
sudo systemctl enable dnsmasq
```

2. 啟動服務

```bash
sudo systemctl start hostapd
sudo systemctl start dnsmasq
```

## 測試熱點

1. 檢查熱點是否廣播中

```bash
iw dev wlan0 scan | grep SSID
```

2. 檢查日誌是否顯示啟動成功

```bash
sudo journalctl -u hostapd
sudo journalctl -u dnsmasq
```

## 查看狀態

1. 確認服務是否已啟動

```bash
sudo systemctl status hostapd
sudo systemctl status dnsmasq
```

2. 啟動服務

```bash
sudo systemctl restart hostapd
sudo systemctl restart dnsmasq
```

3. 網卡無法切換為 AP 模式

```bash
sudo ip link set wlan0 down
sudo iw dev wlan0 set type __ap
sudo ip link set wlan0 up
```


## 測試設備連線

1. 在手機上連接 `RaspberryPi_Hotspot` 熱點，輸入密碼。


