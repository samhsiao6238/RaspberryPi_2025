以下是正確建立 EC2 並安裝 OpenVPN Access Server 的步驟，包含安全組設置與環境安裝。



## 步驟 1：建立正確版本的 EC2
1. 選擇正確的 AMI：
   - 登入 AWS 控制台。
   - 前往 EC2 → Launch Instance。
   - 在 AMI 中選擇 Ubuntu Server 20.04 LTS（官方支援版本）。

2. 選擇實例類型：
   - 建議使用 t2.micro（免費方案適用）。
   - 如果需要更高效能，可選擇更高規格的實例。

3. 配置 Key Pair：
   - 如果已刪除之前的 Key Pair，重新生成一個新的 Key Pair（例如：`MyNewKey.pem`），並下載到本地電腦。

4. 設置安全組（Inbound Rules）：
   - 新建安全組並開放以下端口：
     - TCP 943（管理介面）
     - TCP 443（VPN 連接）
     - UDP 1194（VPN 連接）
     - TCP 22（SSH 連接）

5. 啟動實例並記下 Public IP。



## 步驟 2：連接到 EC2 實例
1. 在終端機使用 SSH 連接：
   ```bash
   ssh -i MyNewKey.pem ubuntu@<Public-IP>
   ```
   將 `<Public-IP>` 替換為您的 EC2 公網 IP 地址。

2. 確保您已設定 Key Pair 的權限：
   ```bash
   chmod 400 MyNewKey.pem
   ```


## 重新安裝

_假如是重新安裝，先進行清除_

1. 清理殘留的配置

```bash
sudo apt-get purge openvpn-as -y
sudo apt-get autoremove -y
sudo apt-get autoclean
```

2. 下載並安裝

```bash
wget https://openvpn.net/downloads/openvpn-as-latest-ubuntu20.amd_64.deb
sudo dpkg -i openvpn-as-latest-ubuntu20.amd_64.deb
sudo apt-get install -f -y
```

3. 確認服務檔案是否存在

```bash
ls /lib/systemd/system/ | grep openvpnas
```

## 步驟 3：安裝必要依賴與 OpenVPN Access Server

1. 更新系統套件

    ```bash
    sudo apt update && sudo apt upgrade -y
    ```

2. 安裝依賴

    ```bash
    sudo apt install -y libmariadb3 bridge-utils net-tools sqlite3 python3-migrate python3-sqlalchemy python3-mysqldb python3-cffi python3-arrow python3-lxml python3-ldap3 python3-defusedxml
    ```

3. 手動下載 `libssl1.1`

```bash
wget http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb
```

4. 手動安裝 `libssl1.1`
```bash
sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2_amd64.deb
```

5. 安裝缺失的依賴
```bash
sudo apt --fix-broken install -y
```

## 下載並安裝 OpenVPN Access Server

1. 刪除可能已經損壞或無效的設定檔

    ```bash
    sudo rm -f /etc/apt/sources.list.d/openvpn-as-repo.list
    sudo rm -f /etc/apt/trusted.gpg.d/openvpn.asc
    ```

2. 添加正確的來源

```bash
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/openvpn-as.gpg] https://packages.openvpn.net/as/debian focal main" | sudo tee /etc/apt/sources.list.d/openvpn-as-repo.list
wget -O - https://packages.openvpn.net/packages-repo.gpg | sudo tee /usr/share/keyrings/openvpn-as.gpg > /dev/null
```

3. 安裝所需的依賴套件

```bash
sudo apt update
sudo apt install -y libmariadb3 bridge-utils net-tools sqlite3 python3-migrate python3-sqlalchemy python3-mysqldb python3-cffi python3-arrow python3-lxml python3-ldap3 python3-defusedxml
```

4. 手動下載並安裝 openvpn-as-bundled-clients 軟體包

```bash
wget https://packages.openvpn.net/as/debian/pool/main/o/openvpn-as-bundled-clients/openvpn-as-bundled-clients_2.14.1_all.deb
sudo dpkg -i openvpn-as-bundled-clients_2.14.1_all.deb
```

5. 安裝 OpenVPN Access Server
```bash
wget https://openvpn.net/downloads/openvpn-as-latest-ubuntu20.amd_64.deb
sudo dpkg -i openvpn-as-latest-ubuntu20.amd_64.deb
sudo apt --fix-broken install -y
```



## 啟用 OpenVPN Access Server

1. 確認 OpenVPN Access Server 是否安裝

```bash
dpkg -l | grep openvpn
```

2. 解除遮罩

```bash
sudo systemctl unmask openvpnas
```

2. 啟動 OpenVPN Access Server
```bash
sudo systemctl start openvpnas
sudo systemctl enable openvpnas
```

3. 確認服務狀態

```bash
sudo systemctl status openvpnas
```

4. 查看日誌

```bash
sudo journalctl -u openvpnas
```

## 步驟 5：配置 OpenVPN Access Server
1. 在瀏覽器中訪問：
   - 輸入 `https://<Public-IP>:943/admin`。
   - 使用預設帳號 `openvpn`，密碼可以透過以下命令重置：
     ```bash
     sudo passwd openvpn
     ```

2. 登入後，按需求配置：
   - 設定 VPN 客戶端的出口伺服器 IP 地址。
   - 生成 `.ovpn` 文件供用戶下載，從而連接 VPN。



完成上述步驟後，您將擁有一個基於 EC2 的 OpenVPN Access Server，可用於翻牆等用途。如需進一步幫助，請提供具體情境！