_測試中_

<br>

# 部署 Ethereum 主網節點

_Raspberry Pi + NVMe SSD_

<br>

## 準備

1. SSD 偵測狀態解析

    ```bash
    lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINT,LABEL,MODEL
    ```

<br>

## 掛載 NVMe SSD

1. 建立掛載點資料夾

    ```bash
    sudo mkdir -p /mnt/ssd
    ```

<br>

2. 掛載 SSD 分割區

    ```bash
    sudo mount /dev/nvme0n1p1 /mnt/ssd
    ```

<br>

3. 確認掛載成功

    ```bash
    df -h | grep ssd
    ```

<br>

## 開機自動掛載

1. 編輯 `/etc/fstab`

    ```bash
    sudo nano /etc/fstab
    ```

<br>

2. 加入一行

    ```bash
    /dev/nvme0n1p1  /mnt/ssd  ext4  defaults,nofail  0  2
    ```

<br>

3. 建立節點資料夾

    ```bash
    sudo mkdir -p /mnt/ssd/geth
    sudo mkdir -p /mnt/ssd/lighthouse
    ```

<br>

## 執行 Geth 節點

_Execution Layer_

<br>

1. 安裝必要編譯工具

    ```bash
    sudo apt update
    sudo apt install -y build-essential git
    ```

<br>

2. 下載與安裝 Go

    ```bash
    cd ~
    wget https://go.dev/dl/go1.22.3.linux-arm64.tar.gz
    sudo rm -rf /usr/local/go
    sudo tar -C /usr/local -xzf go1.22.3.linux-arm64.tar.gz
    ```

<br>

3. 設定 PATH

    ```bash
    echo "export PATH=\$PATH:/usr/local/go/bin" >> ~/.bashrc
    source ~/.bashrc
    ```

<br>

4. 編譯與安裝 Geth

    ```bash
    git clone https://github.com/ethereum/go-ethereum.git
    cd go-ethereum
    make geth
    sudo cp build/bin/geth /usr/local/bin/
    ```

<br>

5. 驗證安裝

    ```bash
    geth version
    ```

<br>

6. 改變 SSD 目錄所有者

    ```bash
    sudo chown -R $USER:$USER /mnt/ssd/geth
    ```

<br>

## 執行 Lighthouse Beacon Node

_共識層_

<br>

1. 安裝 Rust 環境

    ```bash
    curl https://sh.rustup.rs -sSf | sh
    source $HOME/.cargo/env
    ```

<br>

2. 安裝必要依賴

    ```bash
    sudo apt update
    sudo apt install -y build-essential clang pkg-config libssl-dev git cmake
    ```

<br>

3. 下載與編譯 Lighthouse

    ```bash
    git clone https://github.com/sigp/lighthouse.git
    cd lighthouse
    git checkout stable
    make
    ```

<br>

## 啟動前清理與準備

1. 停止所有節點

    ```bash
    sudo pkill -f geth
    sudo pkill -f lighthouse
    ```

<br>

2. 清除 Lighthouse HTTP 快取與 lock 檔

    ```bash
    sudo rm -rf /mnt/ssd/lighthouse/beacon/checkpoint_sync
    sudo rm -rf /mnt/ssd/lighthouse/beacon/http
    sudo rm -rf /mnt/ssd/lighthouse/beacon/tmp
    sudo rm -rf /mnt/ssd/lighthouse/beacon/lockfile
    ```

<br>

## 開始運行節點

1. 第 1 個終端機：執行 Geth

    ```bash
    sudo geth \
        --datadir /mnt/ssd/geth \
        --http \
        --http.addr 0.0.0.0 \
        --http.api eth,net,web3 \
        --authrpc.addr 127.0.0.1 \
        --authrpc.port 8551 \
        --authrpc.vhosts=* \
        --authrpc.jwtsecret /mnt/ssd/geth/jwt.hex
    ```

<br>

2. 第 2 個終端機：執行 Lighthouse Beacon Node

    ```bash
    cd ~/lighthouse
    sudo ./target/release/lighthouse bn \
        --network mainnet \
        --datadir /mnt/ssd/lighthouse \
        --execution-endpoint http://127.0.0.1:8551 \
        --execution-jwt /mnt/ssd/geth/jwt.hex \
        --checkpoint-sync-url https://mainnet.checkpoint.sigp.io \
        --http \
        --http-address 127.0.0.1 \
        --http-port 5152 \
        --metrics \
        --disable-upnp \
        --debug-level debug
    ```

<br>

3. 第 3 個終端機：確認同步狀態（延遲約 1\~2 分鐘），如果成功返回狀態碼（例如 `200` 或 `503`），代表 HTTP API 啟用成功。

    ```bash
    curl http://127.0.0.1:5152/eth/v1/node/health
    ```

<br>

## systemd 開機自動啟動設定

_待補_

<br>
