# å»ºç«‹å¯†é‘°

_ä»¥ä¸‹ç¤ºç¯„å»ºç«‹ `.pem` é‡‘é‘°ä¸¦æŒ‡å®šçµ¦æ¨¹è“æ´¾ä½œç‚º SSH é€£ç·šé©—è­‰ä½¿ç”¨_

<br>

## PEM æ ¼å¼å¯†é‘°

_`PEM` æ ¼å¼å¯†é‘°æ˜¯ä»¥ `Base64` ç·¨ç¢¼ä¸¦é™„å¸¶æ¨™é ­èˆ‡çµå°¾çš„ç´”æ–‡å­—é‡‘é‘°æª”æ¡ˆï¼Œä¹Ÿå°±æ˜¯ `OpenSSL` æ‰€æ¡ç”¨çš„æ¨™æº–é‡‘é‘°æ ¼å¼ï¼Œå¸¸ç”¨æ–¼ SSH èˆ‡ TLS åŠ å¯†èªè­‰ã€‚_

<br>

1. ä½¿ç”¨ `ssh-keygen` æŒ‡ä»¤ç”Ÿæˆå¯†é‘°ï¼›ä½¿ç”¨åƒæ•¸ `-m` æŒ‡å®šæ ¼å¼ç‚º `PEM`ï¼›é€é `-t rsa` æŒ‡å®šé‡‘é‘°é¡å‹ç‚º `RSA`ï¼›é€é `-b` æŒ‡å®šå¯†é‘°é•·åº¦ç‚º `2048 bits`ï¼›æœ€å¾Œï¼Œé€é `-f` æŒ‡å®šè¼¸å‡ºçš„æª”æ¡ˆåç¨±ï¼Œé€™è£¡å­˜æ”¾åœ¨ç³»çµ±é è¨­çš„è·¯å¾‘ `~/.ssh` ä¸­ã€‚

    ```bash
    ssh-keygen -t rsa -b 2048 -m PEM -f ~/.ssh/raspi_key.pem
    ```

    ![](images/img_14.png)

<br>

2. é‹è¡ŒæŒ‡ä»¤å¾Œæœƒåœ¨æŒ‡å®šè·¯å¾‘ä¸­ç”Ÿæˆä¸€çµ„éå°ç¨±å¯†é‘°ï¼ŒåŒ…å«ç§é‘°ï¼ˆ`raspi_key.pem`ï¼‰èˆ‡å…¬é‘°ï¼ˆ`raspi_key.pem.pub`ï¼‰ å„ä¸€å€‹ï¼›å…¶ä¸­ç§é‘°é è¨­æ¬Šé™ç‚º `600` è¡¨ç¤ºåƒ…æ“æœ‰è€…å¯è®€å¯«ï¼Œå¦å¤–å…¬é‘°è¨­ç½®ç‚º `644`ï¼Œå…è¨±ä»–äººè®€å–ã€‚

    ![](images/img_15.png)

<br>

3. ä½¿ç”¨æŒ‡ä»¤ `ssh-copy-id` å°‡ç”Ÿæˆçš„ `å…¬é‘°` å¯«å…¥æ¨¹è“æ´¾çš„ `~/.ssh/authorized_keys` æ–‡ä»¶ä¸­ï¼Œé‹è¡Œå¾Œæœƒæç¤ºè¼¸å…¥å¯†ç¢¼ï¼›å¦‚æ­¤ä¾¿å¯å»ºç«‹å…å¯†ç¢¼ç™»å…¥æ©Ÿåˆ¶ã€‚

    ```bash
    ssh-copy-id -i ~/.ssh/raspi_key.pem.pub <ä½¿ç”¨è€…å¸³è™Ÿ>@<ä¸»æ©Ÿåç¨±.local>
    ```

    ![](images/img_16.png)

<br>

4. æŒ‡å®šè¦ä½¿ç”¨çš„ç§é‘°é€²è¡Œé€£ç·šæ¨¹è“æ´¾ã€‚

    ```bash
    ssh -i ~/.ssh/raspi_key.pem <ä½¿ç”¨è€…å¸³è™Ÿ>@<ä¸»æ©Ÿåç¨±.local>
    ```

    ![](images/img_17.png)

<br>

5. ç‰¹åˆ¥æ³¨æ„ï¼Œé›–ç„¶å·²ç¶“å°‡å…¬é‘°è¤‡è£½åˆ°æ¨¹è“æ´¾ï¼Œä»éœ€ä½¿ç”¨ `-i` æŒ‡å®šç§é‘°ï¼Œé€™æ˜¯å› ç‚º `SSH` é è¨­åªæœƒå°‹æ‰¾ä»¥ä¸‹è·¯å¾‘èˆ‡åç¨±çš„é‡‘é‘°ã€‚

    ```bash
    ~/.ssh/id_rsa
    ~/.ssh/id_ecdsa
    ~/.ssh/id_ed25519
    ```

    ![](images/img_18.png)

<br>

## è³¦äºˆç§é‘°æ¬Šé™

1. ç‚ºå®‰å…¨è€ƒé‡ï¼Œæ‡‰å°‡ç§é‘°æª”æ¬Šé™è¨­ç‚º `400`ï¼›`OpenSSH` é è¨­æœƒæ‹’çµ•ä½¿ç”¨æ¬Šé™éå¯¬çš„ç§é‘°æª”ï¼Œè‹¥æœªè¨­å®šå¯èƒ½å°è‡´é€£ç·šå¤±æ•—ã€‚

    ```bash
    chmod 400 ~/.ssh/raspi_key.pem
    ```

<br>

2. å–æ¶ˆç¢ºè¨­å®šæ–‡ä»¶ `/etc/ssh/sshd_config` ä¸­é è¨­ç‚ºè¨»è§£çš„ `PubkeyAuthentication` è¨­å®šï¼Œç¶­æŒé è¨­å€¼ç‚º `yes`ï¼Œè¡¨ç¤ºå…è¨±å…¬é‘°ç™»å…¥ã€‚

    ```bash
    code /etc/ssh/sshd_config
    ```

    ![](images/img_19.png)

<br>

## è‡ªå‹•åŒ–

_æ¥ä¸‹ä¾†æ˜¯è¼ƒç‚ºé€²éšçš„è¨­å®šæŒ‡å¼•ï¼Œå°‡ç¤ºç¯„åœ¨æœ¬åœ°çš„ MacOS é›»è…¦ä¸­å»ºç«‹è‡ªå‹•åŒ–å·¥ä½œè…³æœ¬ï¼Œé‹è¡Œè…³æœ¬å¯æ•´åˆå‰è¿°çš„å·¥ä½œï¼Œè‡ªå‹•å®Œæˆå»ºç«‹å¯†é‘°æ–‡ä»¶ä¸¦å¯«å…¥æ¨¹è“æ´¾è¨­å®šæ–‡ä»¶çš„å·¥ä½œ_

<br>

1. ä½¿ç”¨ VSCode åœ¨æœ¬æ©Ÿçš„ `~/Documents` è³‡æ–™å¤¾ä¸­å»ºç«‹è…³æœ¬æª” `setup_raspi_ssh.sh`ã€‚

    ```bash
    cd ~/Documents
    code setup_raspi_ssh.sh
    ```

<br>

2. ç·¨è¼¯å…§å®¹å¦‚ä¸‹ï¼›ç·¨è¼¯å¾Œè¨˜å¾—å„²å­˜ã€‚

    ```bash
    #!/bin/bash

    # è¼¸å…¥å¿…è¦åƒæ•¸
    read -p "è«‹è¼¸å…¥æ¨¹è“æ´¾ IP ä½å€: " RASPI_IP
    read -p "è«‹è¼¸å…¥æ¨¹è“æ´¾ä½¿ç”¨è€…åç¨±ï¼ˆé è¨­ piï¼‰: " RASPI_USER
    RASPI_USER=${RASPI_USER:-pi}
    KEY_PATH=~/Desktop/raspi_key.pem

    echo "ğŸ‘‰ é–‹å§‹ç”¢ç”Ÿ PEM é‡‘é‘°..."
    ssh-keygen -t rsa -b 2048 -m PEM -f "$KEY_PATH" -N ""

    echo "ğŸ‘‰ å‚³é€å…¬é‘°è‡³æ¨¹è“æ´¾..."
    ssh-copy-id -i "$KEY_PATH.pub" "$RASPI_USER@$RASPI_IP"

    echo "ğŸ‘‰ è¨­å®šç§é‘°æ¬Šé™..."
    chmod 400 "$KEY_PATH"

    echo "âœ… è¨­å®šå®Œæˆï¼Œå¯ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ç™»å…¥ï¼š"
    echo "ssh -i $KEY_PATH $RASPI_USER@$RASPI_IP"
    ```

<br>

3. è¿”å›çµ‚ç«¯æ©Ÿä¸­ï¼Œè³¦äºˆ `åŸ·è¡Œ` æ¬Šé™ã€‚

    ```bash
    chmod +x setup_raspi_ssh.sh
    ```

<br>

4. åŸ·è¡Œè…³æœ¬ï¼Œæœƒåœ¨çµ‚ç«¯æ©Ÿä¸­æç¤ºè¼¸å…¥ IPã€ä½¿ç”¨è€…åç¨±ä»¥åŠæ¨¹è“æ´¾é€£ç·šå¯†ç¢¼ã€‚

    ```bash
    ./setup_raspi_ssh.sh
    ```

<br>

5. å®Œæˆå¾Œæœƒå»ºç«‹å¯†é‘°ï¼Œä¸¦æä¾›é€£ç·šæŒ‡ä»¤ï¼Œå¯è¤‡è£½å¾Œåœ¨çµ‚ç«¯æ©Ÿä¸­é‹è¡Œã€‚

    ![](images/img_20.png)

<br>

## å»ºç«‹å°è©±æ¡†

_å„ªåŒ–å‰ä¸€å€‹æ­¥é©Ÿï¼Œçµåˆ `AppleScript` æ”¹å¯«ç‚ºå¸¶æœ‰ `GUI` è¼¸å…¥å°è©±æ¡†çš„ `Shell Script`_

<br>

1. åœ¨ç›¸åŒè³‡æ–™å¤¾ä¸­å»ºç«‹æ–°çš„è…³æœ¬ `setup_raspi_ssh_gui.sh`ã€‚

    ```bash
    cd ~/Documents
    code setup_raspi_ssh_gui.sh
    ```

<br>

2. ç¢ºä¿å·²å®‰è£ expectï¼›é—œæ–¼é€¾æ™‚çš„è¦å®šï¼Œå› ç‚º macOS åŸ·è¡Œ AppleScript å°è©±æ¡†çš„é€¾æ™‚é è¨­ç‚ºç´„ 60 ç§’ï¼Œè€Œ osascript ç„¡æ³•å–æ¶ˆé€¾æ™‚é™åˆ¶ï¼Œæ‰€ä»¥ç”¨ osascript åŸ·è¡Œæ™‚åŠ ä¸Š || exit 1 æ­é… if åˆ¤æ–·ç¢ºä¿è¼¸å…¥å­˜åœ¨ï¼Œä¾†å¼·åˆ¶ä¸­æ­¢æ•´å€‹è…³æœ¬ï¼›æœªè¨­ç½®æ™‚ï¼Œæœƒåœ¨é€¾æ™‚ä¹‹å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€å€‹æ­¥é©Ÿï¼Œé€™æ¨£è¨­è¨ˆä¸¦ä¸åˆç†

    ```bash
    brew install expect
    ```

<br>

3. å¯«å…¥ä»¥ä¸‹å…§å®¹ä¸¦å„²å­˜ã€‚

    ```bash
    #!/bin/bash

    # GUI è¼¸å…¥ï¼šIP ä½å€
    RASPI_IP=$(osascript -e 'try
        set userInput to display dialog "è«‹è¼¸å…¥æ¨¹è“æ´¾ IP ä½å€ï¼š" default answer "" with title "SSH è¨­å®š - IP ä½å€" buttons {"ç¢ºå®š"} default button "ç¢ºå®š"
        text returned of userInput
    on error
        display dialog "âŒ æœªè¼¸å…¥ IP æˆ–æ“ä½œé€¾æ™‚ï¼Œè…³æœ¬å·²çµ‚æ­¢ã€‚" buttons {"OK"} with title "ä½œæ¥­ä¸­æ­¢"
        return
    end try') || exit 1

    if [ -z "$RASPI_IP" ]; then
        osascript -e 'display dialog "âŒ IP ä½å€ä¸å¯ç‚ºç©ºã€‚" buttons {"OK"} with title "è¼¸å…¥éŒ¯èª¤"'
        exit 1
    fi

    # GUI è¼¸å…¥ï¼šä½¿ç”¨è€…åç¨±
    RASPI_USER=$(osascript -e 'try
        set userInput to display dialog "è«‹è¼¸å…¥æ¨¹è“æ´¾ä½¿ç”¨è€…åç¨±ï¼ˆé è¨­ç‚º piï¼‰ï¼š" default answer "pi" with title "SSH è¨­å®š - ä½¿ç”¨è€…åç¨±" buttons {"ç¢ºå®š"} default button "ç¢ºå®š"
        text returned of userInput
    on error
        display dialog "âŒ æœªè¼¸å…¥ä½¿ç”¨è€…åç¨±æˆ–æ“ä½œé€¾æ™‚ï¼Œè…³æœ¬å·²çµ‚æ­¢ã€‚" buttons {"OK"} with title "ä½œæ¥­ä¸­æ­¢"
        return
    end try') || exit 1

    if [ -z "$RASPI_USER" ]; then
        osascript -e 'display dialog "âŒ ä½¿ç”¨è€…åç¨±ä¸å¯ç‚ºç©ºã€‚" buttons {"OK"} with title "è¼¸å…¥éŒ¯èª¤"'
        exit 1
    fi

    # GUI è¼¸å…¥ï¼šå¯†ç¢¼
    RASPI_PASS=$(osascript -e 'try
        set pwInput to display dialog "è«‹è¼¸å…¥æ¨¹è“æ´¾ä½¿ç”¨è€…å¯†ç¢¼ï¼š" default answer "" with hidden answer with title "SSH è¨­å®š - å¯†ç¢¼è¼¸å…¥" buttons {"ç¢ºå®š"} default button "ç¢ºå®š"
        text returned of pwInput
    on error
        display dialog "âŒ æœªè¼¸å…¥å¯†ç¢¼æˆ–æ“ä½œé€¾æ™‚ï¼Œè…³æœ¬å·²çµ‚æ­¢ã€‚" buttons {"OK"} with title "ä½œæ¥­ä¸­æ­¢"
        return
    end try') || exit 1

    if [ -z "$RASPI_PASS" ]; then
        osascript -e 'display dialog "âŒ å¯†ç¢¼ä¸å¯ç‚ºç©ºã€‚" buttons {"OK"} with title "è¼¸å…¥éŒ¯èª¤"'
        exit 1
    fi

    # é‡‘é‘°ä½ç½®
    KEY_PATH=~/.ssh/raspi_key.pem

    # è‹¥é‡‘é‘°å·²å­˜åœ¨ï¼Œè©¢å•æ˜¯å¦è¦†è“‹
    if [ -f "$KEY_PATH" ]; then
        OVERWRITE=$(osascript -e 'display dialog "æª¢æ¸¬åˆ°é‡‘é‘°å·²å­˜åœ¨ã€‚\næ˜¯å¦è¦è¦†è“‹ raspi_key.pemï¼Ÿ" buttons {"å¦", "æ˜¯"} default button "å¦"' -e 'button returned of result')
        if [ "$OVERWRITE" = "æ˜¯" ]; then
            rm -f "$KEY_PATH" "$KEY_PATH.pub"
        else
            osascript -e 'display dialog "å·²å–æ¶ˆé‡‘é‘°å»ºç«‹ç¨‹åºã€‚" buttons {"OK"} default button 1 with title "ä½œæ¥­ä¸­æ­¢"'
            exit 1
        fi
    fi

    # å»ºç«‹ PEM é‡‘é‘°
    ssh-keygen -t rsa -b 2048 -m PEM -f "$KEY_PATH" -N ""

    # ä½¿ç”¨ expect è‡ªå‹•ä¸Šå‚³å…¬é‘°ä¸¦è¼¸å…¥å¯†ç¢¼
    expect <<EOF
    set timeout 10
    spawn ssh-copy-id -i "$KEY_PATH.pub" "$RASPI_USER@$RASPI_IP"
    expect {
        "(yes/no)?" {
            send "yes\r"
            exp_continue
        }
        "password:" {
            send "$RASPI_PASS\r"
        }
    }
    expect eof
    EOF

    # ä¿®æ”¹ç§é‘°æ¬Šé™
    chmod 400 "$KEY_PATH"

    # è¤‡è£½ç™»å…¥æŒ‡ä»¤åˆ°å‰ªè²¼ç°¿
    LOGIN_CMD="ssh -i ~/.ssh/raspi_key.pem $RASPI_USER@$RASPI_IP"
    echo "$LOGIN_CMD" | pbcopy

    # é¡¯ç¤º GUI å®Œæˆæç¤º
    osascript -e 'display dialog "âœ… è¨­å®šå®Œæˆï¼\n\nSSH ç™»å…¥æŒ‡ä»¤å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼š\n\n'"$LOGIN_CMD"'\n\nè«‹è‡³çµ‚ç«¯æ©Ÿè²¼ä¸Šä½¿ç”¨ã€‚" buttons {"å®Œæˆ"} default button 1 with title "SSH è¨­å®šå®Œæˆ"'
    ```

<br>

4. å›åˆ°çµ‚ç«¯æ©Ÿä¸­ä¿®æ”¹æ–‡ä»¶æ¬Šé™ã€‚

    ```bash
    chmod +x setup_raspi_ssh_gui.sh
    ```

<br>

5. åœ¨çµ‚ç«¯æ©ŸåŸ·è¡Œè…³æœ¬ã€‚

    ```bash
    ./setup_raspi_ssh_gui.sh
    ```

    ![](images/img_21.png)

<br>

6. å®Œæˆæ™‚æœƒé¡¯ç¤ºæŒ‡ä»¤ã€‚

    ![](images/img_22.png)

<br>

## å»ºç«‹æ¡Œé¢æ·å¾‘

_é€²ä¸€æ­¥å„ªåŒ–å‰æ­¥é©Ÿå®Œæˆçš„è‡ªå‹•åŒ–å·¥ä½œï¼Œæ¥ä¸‹ä¾†å»ºç«‹ `Automator .app` æ¡Œé¢æ‡‰ç”¨_

<br>

1. é€²å…¥çµ‚ç«¯æ©Ÿï¼Œä½¿ç”¨æŒ‡ä»¤å»ºç«‹ `Automator` ç”¨çš„ `.workflow AppleScript` åŸ·è¡Œå™¨ï¼›ä»¥ä¸‹æŒ‡ä»¤ä¸æœƒæ‰“é–‹çµ‚ç«¯æ©Ÿï¼Œè€Œæ˜¯åœ¨èƒŒæ™¯é‹è¡Œã€‚

    ```bash
    APP_NAME="Setup Raspi SSH"
    APP_PATH=~/Desktop/"$APP_NAME.app"
    SCRIPT_PATH=~/Documents/setup_raspi_ssh_gui.sh

    osacompile -e "do shell script \"chmod +x '$SCRIPT_PATH'; bash '$SCRIPT_PATH'\"" -o "$APP_PATH"
    ```

<br>

2. å®Œæˆæ™‚é¡¯ç¤ºå¦‚ä¸‹è¨Šæ¯ï¼Œä»£è¡¨ osacompile æˆåŠŸå»ºç«‹æˆ–è¦†è“‹äº†æ‡‰ç”¨ç¨‹å¼ Setup Raspi SSH.appï¼Œä¸¦å°‡å®ƒæ”¾åœ¨æ¡Œé¢ï¼Œé€™æ˜¯ä¸€å€‹å¯ä»¥ç›´æ¥åŸ·è¡Œçš„ .app åœ–å½¢ä»‹é¢å•Ÿå‹•å™¨

    ![](images/img_23.png)

<br>

3. æ¥è‘—é»æ“Šæ¡Œé¢æ‡‰ç”¨å•Ÿå‹•ã€‚

    ![](images/img_24.png)

<br>

4. æˆåŠŸé‹è¡Œæœƒé¡¯ç¤ºå¦‚ä¸‹ã€‚

    ![](images/img_25.png)

<br>

___

_END_