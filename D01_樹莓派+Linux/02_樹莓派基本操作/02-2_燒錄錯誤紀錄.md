# 燒錄錯誤紀錄

_這是系統的 Bug，Windows 系統燒錄 SD 卡之後，無法正確連線 WiFi；記錄於 2025/06_

<br>

## 問題描述

_經查發現以下三處出現斷行，導致開機後設定出錯_

<br>

1. 第一。

    ```bash
    if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
    /usr/lib/raspberrypi-sys-mods/imager_custom set_wlan 'A590301' '131d58fdba03241dd8e369c6e691c2eeae01d8d8d3280b46d5dd6cf3896a71b9' 'TW
    '
    ```

    ![](images/img_258.png)


<br>

2. 第二。

    ```bash
    if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
    /usr/lib/raspberrypi-sys-mods/imager_custom set_keymap 'us
    '
    ```

    ![](images/img_259.png)

<br>

3. 第三。

    ```bash
    XKBLAYOUT="us
    "
    ```

    ![](images/img_260.png)

<br>

## 操作

1. 燒錄完成後，先依據指示退出卡片並隨即插回電腦，在檔案總管中會看到一個 `bootfs` 磁區，這就是 SD 卡片中可讀的區域。

    ![](images/img_261.png)

<br>

2. 其中有一個腳本 `firstrun.sh`，點擊後使用 `VSCode` 或筆記本開啟；特別注意，SD 卡片一但插入樹莓派開機後這個腳本就會因執行而被自動移除，所以要在啟動前才能進行編輯。

    ![](images/img_262.png)

<br>

3. 將前述三個錯誤斷行處修正，就是取消斷行。

    ```bash
    # 第一處
    if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
    /usr/lib/raspberrypi-sys-mods/imager_custom set_wlan 'A590301' '131d58fdba03241dd8e369c6e691c2eeae01d8d8d3280b46d5dd6cf3896a71b9' 'TW'
    # 其餘略 ...

    # 第二處
    if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
    /usr/lib/raspberrypi-sys-mods/imager_custom set_keymap 'us'
    # 其餘略 ...

    # 第三處
    XKBLAYOUT="us"
    # 其餘略 ...
    ```

<br>

4. 以上完成後步驟，在插入樹莓派開機，就可以正確連線了。

<br>

## 補充說明

_該文件設置的項目_

<br>

1. 設定主機名稱 `hostname`，共有以下三處；可手動修改 `<填入-主機名稱>`，不用引號包覆、不用加上尾綴 `.local`；代碼表示將自定義 `hostname`，若沒有順利調用 `imager_custom` 寫入，會手動寫入 `/etc/hostname` 和修改 `/etc/hosts` 兩個文件。

    ```bash
    CURRENT_HOSTNAME=`cat /etc/hostname | tr -d " \t\n\r"`
    if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
    /usr/lib/raspberrypi-sys-mods/imager_custom set_hostname <填入-主機名稱>
    else
    echo <填入-主機名稱> >/etc/hostname
    sed -i "s/127.0.1.1.*$CURRENT_HOSTNAME/127.0.1.1\t<填入-主機名稱>/g" /etc/hosts
    fi
    ```

<br>

2. 設定預設使用者帳號及密碼；若要手動變更有多處需要修改；特別注意，`<密碼雜湊字串>` 不可填寫明文密碼，可透過指令將明文轉換為雜湊字串 `mkpasswd --method=SHA-512`。

    ```bash
    # 第一處
    /usr/lib/userconf-pi/userconf '<新使用者名稱>' '<密碼雜湊字串>'

    # 第二處，這裡僅修改密碼
    echo "$FIRSTUSER:"'<密碼雜湊字串>' | chpasswd -e

    # 第三處
    if [ "$FIRSTUSER" != "<新使用者名稱>" ]; then
        usermod -l "<新使用者名稱>" "$FIRSTUSER"
        usermod -m -d "/home/<新使用者名稱>" "<新使用者名稱>"
        groupmod -n "<新使用者名稱>" "$FIRSTUSER"

    # 第四處
    sed /etc/lightdm/lightdm.conf -i -e "s/^autologin-user=.*/autologin-user=<新使用者名稱>/"

    # 第五處
    sed /etc/systemd/system/getty@tty1.service.d/autologin.conf -i -e "s/$FIRSTUSER/<新使用者名稱>/"
    sed -i "s/^$FIRSTUSER /<新使用者名稱> /" /etc/sudoers.d/010_pi-nopasswd
    ```

<br>

3. 設定 WiFi SSID、加密密碼和國家代碼；無前述工具時，手動寫入 `/etc/wpa_supplicant/wpa_supplicant.conf` 設定 WiFi，並設定權限及解除 wifi 封鎖。

    ```bash
    if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
    /usr/lib/raspberrypi-sys-mods/imager_custom set_wlan '<SSID-名稱>' '<WiFi-密碼雜湊>' 'TW'
    else
    cat >/etc/wpa_supplicant/wpa_supplicant.conf <<'WPAEOF'
    country=TW
    ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
    ap_scan=1

    update_config=1
    network={
        ssid="<SSID-名稱>"
        psk=<WiFi-密碼雜湊>
    }
    ```

<br>

4. 設定鍵盤佈為 `us`、時區為 `Asia/Taipei`；同樣，無該工具時手動重配置 `/etc/timezone`、`/etc/default/keyboard` 及鍵盤設定。

<br>

5. 另外也設定啟用 SSH，否則透過 systemd 啟用 ssh 服務。

    ```bash
    if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
    /usr/lib/raspberrypi-sys-mods/imager_custom enable_ssh
    else
    systemctl enable ssh
    fi
    ```

<br>

6. 刪除 `/boot/firstrun.sh` 腳本本身。

    ```bash
    rm -f /boot/firstrun.sh
    ```

<br>

7. 從 `/boot/cmdline.txt` 中移除 `systemd.run` 相關參數>

    ```bash
    sed -i 's| systemd.run.*||g' /boot/cmdline.txt
    exit 0
    ```

<br>

8. 可查看 `/boot/cmdline.txt`；這三個參數讓系統在啟動時執行 `/boot/firstrun.sh` 腳本，執行成功後會自動重啟，因為前一行已將腳本刪除，所以完成首次設定後必須移除這些參數。

    ```
    systemd.run=/boot/firstrun.sh systemd.run_success_action=reboot systemd.unit=kernel-command-line.target
    ```

<br>

___

_END_