# 重置 PostgreSQL

_重置資料庫伺服器等同於完全清空、回到初次安裝完成的狀態_

<br>

## 查詢服務狀態

1. 在 Linux 系統。

    ```bash
    systemctl status postgresql
    ```

<br>

2. 在 MacOS 上使用以下指令。

    ```bash
    brew services list
    ```

    ![](images/img_05.png)

<br>

## 停止服務

1. 在 MacOS 停止服務時，若有多版本，需指定所要停止的版本，使用 `@` 符號加上版本號如下。

    ```bash
    brew services stop postgresql@16
    ```

    ![](images/img_07.png)

<br>

2. 若無指定版本號，預設會以第一個版本作為目標，若該版本服務未啟動，會顯示相關錯誤。

    ![](images/img_06.png)

<br>

3. Linux。

    ```bash
    sudo systemctl stop postgresql
    ```

<br>

## 重置資料

1. 確認安裝位置；若是使用 `Homebrew` 安裝，路徑通常在 `/usr/local/var/postgres` 或 `/opt/homebrew/var/postgres`，可先透過指令進行檢查。

    ```bash
    ls /usr/local/var/postgres
    ls /opt/homebrew/var/postgres
    ```

<br>

2. 可使用指令整機搜尋，不過這個方式很佔用時間。

    ```bash
    find / -type d -name "postgres" 2>/dev/null
    ```

<br>

3. 使用 brew 查詢。

    ```bash
    brew --prefix postgresql@16
    ```

<br>

4. 也可以在資料庫中查詢，不過這得在服務停止之前進行。

    ```sql
    psql -U postgres -c "SHOW data_directory;"
    ```

<br>

5. 確認所在位置後，手動刪除全部資料；特別注意，刪除的是 `/opt/homebrew/var/*`，而不是 `/opt/homebrew/opt/*`，因為前者是存放資料，後者是軟體本身。

    ```bash
    rm -rf /opt/homebrew/var/postgresql@16/*
    ```

<br>

4. 重新初始化資料庫

    ```bash
    initdb /opt/homebrew/var/postgresql@16
    ```

<br>

5. 啟動 PostgreSQL

    ```bash
    brew services start postgresql@16
    ```

<br>

## 重新安裝

_僅重新安裝軟體主體，不會自動移除或清空資料目錄_

<br>

1. 重新安裝

    ```bash
    brew uninstall postgresql
    brew install postgresql
    brew services start postgresql
    ```

<br>

## 自動化

1. 指令一次搞定

    ```bash
    brew services stop postgresql
    rm -rf /usr/local/var/postgres/*
    initdb /usr/local/var/postgres
    brew services start postgresql
    ```

<br>

## 僅清除所有資料庫與用戶

1. 如果只是要刪光所有 `user/database` 而不重建目錄，可依序把所有的資料庫與帳號 drop 掉。

    ```bash
    psql -U postgres -c "DROP DATABASE IF EXISTS testdb;"
    psql -U postgres -c "DROP USER IF EXISTS sam6238;"
    ```

<br>

