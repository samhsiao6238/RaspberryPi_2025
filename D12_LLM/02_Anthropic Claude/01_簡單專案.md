# 簡易專案

_讓樹莓派成為一台智慧知識查詢終端，實現抓取本地檔案或網頁內容，然後用 Claude API 進行知識抽取、問答（Q\&A）與摘要。_

## 準備與安裝

1. 更新

```bash
sudo apt update
```

2. 建立虛擬環境

```bash
# 略
```

3. 安裝必要套件；`openai` 套件用於範例，也適合換成官方 Claude SDK 或任何 HTTP 調用套件。

```bash
pip install requests beautifulsoup4 openai
```

4. 建立文件資料夾。

```bash
mkdir -p ~/Documents/knowledge
```

## Claude API Key

1. 到 [Anthropic Claude 官方平台](https://console.anthropic.com/) 申請帳號並取得 API Key。

2. 記下你的金鑰，稍後將放到 `.env` 或直接程式碼中。


## 資料來源準備】

1. 本地檔案如 TXT/MD/CSV，可使用任意要查詢的知識如產品說明書等放在 `/home/pi/documents/knowledge/`。

2. 或是爬取網頁數據。

## PDF 解析

1. 先安裝必要套件

```bash
pip install pdfplumber easyocr
```

2. 定義函數

```python
import pdfplumber
import easyocr
import numpy as np

def extract_pdf_with_ocr(filepath, lang=['ch_sim','en']):
    reader = easyocr.Reader(lang, gpu=False)
    result_text = []
    with pdfplumber.open(filepath) as pdf:
        for page in pdf.pages:
            img = page.to_image(resolution=300).original
            # 轉成 numpy array
            img_np = np.array(img)
            ocr_result = reader.readtext(img_np)
            page_text = ' '.join([seg[1] for seg in ocr_result])
            if page_text.strip():
                result_text.append(page_text)
    return '\n'.join(result_text)
```

3. 可進行測試；特別注意，會提示 ` This module is much faster with a GPU`，這是因為 `easyocr` 會自動檢查環境有沒有 `CUDA（NVIDIA 顯卡）` 支援，樹莓派是沒有 GPU 的，所以會自動用 CPU 模式。

```python
import os
pdf_path = os.path.expanduser(
    '~/Documents/knowledge/米家空氣清淨器 5 Pro.pdf'
)
text = extract_pdf_with_ocr(pdf_path)
print(text[:1000])
```

![](images/img_01.png)

4. 定義調用本地文件的函數，同時納入 PDF 解析。

```python
import os

def load_local_files(directory):
    directory = os.path.expanduser(directory)
    all_text = ""
    for fname in os.listdir(directory):
        path = os.path.join(directory, fname)
        if not os.path.isfile(path):
            continue
        # 純文字檔
        if fname.endswith(('.txt', '.md', '.csv')):
            try:
                with open(path, encoding='utf-8') as f:
                    all_text += f.read() + "\n"
            except Exception as e:
                print(f"讀取文字檔失敗：{fname}，原因：{e}")
        # PDF 檔案（自動判斷用 OCR）
        elif fname.endswith('.pdf'):
            try:
                all_text += extract_pdf_with_ocr(path) + "\n"
            except Exception as e:
                print(f"解析 PDF 失敗：{fname}，原因：{e}")
    return all_text
```


## 資料網頁資訊

1. 抓網頁內容

```python
import requests
from bs4 import BeautifulSoup

def fetch_webpage(url, min_length=50):
    resp = requests.get(url)
    # 避免中文亂碼
    resp.encoding = resp.apparent_encoding
    soup = BeautifulSoup(resp.text, 'html.parser')
    
    # 嘗試優先找 <article>、<main> 或主要內容區
    for tag in ['article', 'main', 'section', 'body']:
        main = soup.find(tag)
        if main and len(main.get_text(strip=True)) > min_length:
            return main.get_text(separator='\n', strip=True)
    
    # fallback: 將所有 <p> 文字串起來
    ps = soup.find_all('p')
    content = '\n'.join(p.get_text(strip=True) for p in ps)
    if len(content) > min_length:
        return content
    
    # fallback: 全頁文字
    return soup.get_text(separator='\n', strip=True)
```



## 整理知識資料

1. 合併本地檔案與網頁資料為一段大文字

```python
docs = load_local_files('/home/pi/documents/knowledge/')
docs += fetch_webpage('https://zh.wikipedia.org/zh-tw/樹莓派')
```

## 建立查詢

1. 送資料給 Claude 進行知識抽取／問答，以 Anthropic Claude API (v2024.06) 為例。

```python
import requests

def ask_claude(question, context, api_key):
    url = "https://api.anthropic.com/v1/messages"
    headers = {
        "x-api-key": api_key,
        "anthropic-version": "2023-06-01",
        "content-type": "application/json"
    }
    data = {
        # 可根據你的帳號權限替換
        "model": "claude-3-sonnet-20240229",
        "max_tokens": 1024,
        "system": "你是一個知識查詢助理，根據 context 回答使用者問題。",
        "messages": [{
            "role": "user", 
            "content": f"知識內容：\n{context}\n\n請根據上述內容回答：{question}"
        }]
    }
    r = requests.post(url, headers=headers, json=data)
    if r.ok:
        resp = r.json()
        return resp['content'][0]['text']
    else:
        print("API 錯誤：", r.text)
        return None
```

## 整合互動式查詢

1. 寫一個互動 CLI 介面。

```python
if __name__ == '__main__':
    api_key = "你的_Claude_API_Key"
    # 前面已經合併的知識
    context = docs
    print("智慧查詢系統已啟動，輸入問題即可查詢（Ctrl+C 離開）：")
    while True:
        q = input("請輸入你的問題：")
        ans = ask_claude(q, context, api_key)
        print("Claude 回答：", ans)
```

## RAG

1. 將本地知識切割成片段，先用簡單 embedding 比對與召回，後丟給 Claude 增強答案品質。

## Web 介面

_用 Flask 或 Streamlit 包裝成可視化網頁版_

## 定時任務

_用 cron 週期性爬網頁或同步本地資料_
