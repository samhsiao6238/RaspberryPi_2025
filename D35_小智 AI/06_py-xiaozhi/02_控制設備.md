# 控制設備

_在兩個地方可以看到 `Lamp`_

<br>

## application.py

_編輯這份文件如下_

<br>

1. 編輯 `_initialize_iot_devices` 函數，加入以下標註了 `「+」` 的代碼。

    ```python
    # 這是原本的
    from src.iot.thing_manager import ThingManager
    from src.iot.things.lamp import Lamp
    # 「+」導入新模組
    from src.iot.things.NewThing import NewThing

    # 這是原本的
    thing_manager = ThingManager.get_instance()
    thing_manager.add_thing(Lamp())

    # 「+」添加新設備
    thing_manager.add_thing(NewThing())
    ```

<br>

## 建立新模組 `NewThing.py`

1. 可直接複製 `iot/things` 資料夾中的 `lamp.py`，並更名為 `NewThing.py`。

<br>

2. 編輯內容 `NewThing.py`，使用替換方式，將 `Lamp` 都改為 `NewThing`；這個步驟只是作為示範，可藉此觀察修改部分。

    ![](images/img_13.png)

<br>

3. 將 `NewThing.py` 內容修改如下；以下標註 `「+」` 部分就是新增代碼、`「*」` 就是修改部分。

    ```python
    from src.iot.thing import Thing
    # 「＋」依據新功能加入新模組
    import requests

    class NewThing(Thing):
        def __init__(self):
            # 「*」改為新模組以及新敘述字串
            super().__init__(
                "NewThing",
                "一個測試用的 Line 通知裝置"
            )

            # 「＋」加入新的輸出訊息，供調適目的使用
            print(f"[虛擬設備] Line 通知設備初始化完成")

            # 「＋」註冊屬性 `add_property` 及註冊方法 `add_method`
            # ...
    ```

<br>

## 註冊屬性及方法

_先說明屬性與方法的註冊，後續再提供所註冊的函數_

<br>

1. 註冊函數；第一個參數是給這個函數在 `ThingManager` 中註冊唯一識別名稱，第二個參數是提示詞，第三個參數則是調用自訂函數。

    ```python
    # 加入函數：將自訂函數加入，並定義 `提示詞`
    self.add_method(
        "GetUSDQuote", "取得美金報價", [], 
        lambda params: self._get_usd_quote()
    )
    ```

<br>

## 自定義函數

1. 【自定義函數】取得美元報價。

    ```python
    # 自訂函數：取得報價
    def _get_usd_quote(self):
        try:
            response = requests.get("https://tw.rter.info/capi.php")
            if response.status_code == 200:
                data = response.json()
                usd_twd = data["USD"]["Exrate"]
                msg = f"目前美金匯率約為 {usd_twd:.2f} 新台幣"
            else:
                msg = "無法取得美金報價（API錯誤）"
        except Exception as e:
            msg = f"取得匯率時發生錯誤：{e}"

        self._send_line_notify(msg)
        print(f"[虛擬設備] 已發送美金報價 Line 訊息：{msg}")
        return {"status": "success", "message": msg}
    ```

<br>

2. 【自定義函數】發送 `Line 通知`；已棄用，會再修正。

    ```python
    def _send_line_notify(self, message: str):
        token = "WemrA5mtsqcBcvTEG59tXmVGVTDj8wifXH51GzjWXx8"
        url = "https://notify-api.line.me/api/notify"
        headers = {
            "Authorization": f"Bearer {token}"
        }
        data = {
            "message": message
        }
        try:
            response = requests.post(url, headers=headers, data=data)
            if response.status_code != 200:
                print(f"[錯誤] 發送 Line Notify 失敗: {response.text}")
        except Exception as e:
            print(f"[例外] 發送 Line Notify 發生錯誤: {e}")
    ```

___

_未完_