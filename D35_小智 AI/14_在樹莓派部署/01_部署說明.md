# 樹莓派

_[參考](https://github.com/Huang-junsen/py-xiaozhi)，在樹莓派上安裝並運行小智 AI 聊天助理，可以依照以下步驟來設置。_

<br>

## 準備工作

_以下會使用到虛擬環境，這裡不贅述建立過程，命名為 `envXiaozhi`_

1. 進入虛擬環境。

<br>

2. 更新莓派系統。

    ```bash
    sudo apt update && sudo apt upgrade -y
    ```

<br>

3. 安裝依賴，因為 `py-xiaozhi` 需要音頻處理，所以需要安裝相關的 FFmpeg 和 PortAudio 等工具。

    ```bash
    sudo apt install python3-pyaudio portaudio19-dev ffmpeg libopus0 libopus-dev -y
    ```

<br>

4. 下載 py-xiaozhi。

    ```bash
    cd ~/Documents && git clone https://github.com/Huang-junsen/py-xiaozhi.git && cd py-xiaozhi
    ```

<br>

5. 安裝依賴。

    ```bash
    pip install -r requirements.txt
    ```

<br>

## 設置

1. 檢查麥克風；若有麥克否，確認卡號並在後續的指令中帶入。

    ```bash
    arecord -l
    ```

    ![](images/img_01.png)

<br>

2. 也可將卡號存入變數；以下會擷取第一個 USB 音訊裝置的卡號。

    ```bash
    card_num=$(arecord -l | grep "Usb Camera Audio" | awk '{print $2}' | tr -d ':')
    echo $card_num
    ```

<br>

3. 列出播放裝置。

    ```bash
    aplay -l
    ```

<br>

4. 使用 USB 麥克風進行錄音測試，以下指令將會帶入前面步驟所取得的卡號，並使用預設播放裝置進行播放；若要停止錄音可使用組合鍵 `control+C`。

    ```bash
    arecord -D plughw:$card_num,0 -f cd test.wav
    aplay test.wav
    ```

<br>

5. 假如無法播放，可逐一進行測試。

    ```bash
    aplay -D plughw:0,0 test.wav   # HDMI-0
    aplay -D plughw:1,0 test.wav   # HDMI-1
    aplay -D plughw:2,0 test.wav   # USB Audio
    ```

<br>

6. 編輯 ALSA 配置。

    ```bash
    sudo nano /etc/asound.conf
    ```

<br>

7. 添加以下內容；因為使用內建麥克風與喇叭的設備，所以同樣卡號。

    ```ini
    # 設定錄音設備（USB 麥克風 - card 2）
    pcm.mic_in {
        type plug
        slave.pcm "hw:2,0"
    }

    ctl.mic_in {
        type hw
        card 2
    }

    # 設定播放設備（USB 喇叭 - card 2）
    pcm.speaker_out {
        type plug
        slave.pcm "hw:2,0"
    }

    ctl.speaker_out {
        type hw
        card 2
    }

    # 設定預設設備
    pcm.!default {
        type asym
        playback.pcm "speaker_out"
        capture.pcm "mic_in"
    }
    ```

<br>

8. 儲存並重啟 ALSA。

    ```bash
    sudo alsactl init
    ```

<br>

9. 測試錄音 `3` 秒。

    ```bash
    arecord -f cd -d 3 test.wav
    aplay test.wav
    ```

<br>

10. 也可以直接測試內建語音樣本。

    ```bash
    aplay /usr/share/sounds/alsa/Front_Center.wav
    ```

<br>

11. 若要調整音量。

    ```bash
    alsamixer
    ```

<br>

## CLI 模式

_可在本地電腦使用終端機連線樹莓派運行_

<br>

1. 安裝必要套件。

    ```bash
    pip install opencv-python
    ```

<br>

2. 使用 apt 安裝 PyQt5 的預編譯版本。

    ```bash
    sudo apt update
    sudo apt install python3-pyqt5
    ```

<br>

2. 手動鏈接 PyQt5 到虛擬環境。

    ```bash
    cd ~/Documents/PythonVenvs/envFlask/lib/python3.11/site-packages
    ln -s /usr/lib/python3/dist-packages/PyQt5 .
    ```

<br>

3. 樹莓派可使用 CLI 模式。

    ```bash
    python main.py --mode cli
    ```

<br>

## GUI 模式

_選擇 GUI 模式進行連線時，需在樹莓派桌面啟動終端機_

<br>

1. GUI 模式需要 `tkinter`，先安裝必要套件。

    ```bash
    sudo apt install python3-tk
    ```

<br>

2. 運行。

    ```bash
    python main.py
    ```

<br>

## 補充說明

1. 若出現音量控制問題，可以手動安裝 ALSA。

    ```bash
    sudo apt install alsa-utils
    ```

<br>

2. 調整音量。

    ```bash
    amixer set PCM 90%
    ```

<br>

## 使用 WebSocket 連接自建伺服器

_如果不想使用官方伺服器，也可以自行部署 xiaozhi-esp32-server，然後修改 `main.py` 內的 WebSocket 連接地址。_

<br>

___

_END_
