# 部署 K3s

_因為 K8s 需要耗用大量資源，不建議在邊緣設備如樹莓派上部署 K8s，以下將進行 K3s 部署。_ 

<br>

## 連線樹莓派

1. 連接樹莓派。

    ```
    ssh pi@<hostname>.local
    ```

<br>

2. 確認當前 IP；以下指令會做篩選、僅顯示 `有線網路 eth0`。

    ```bash
    ip -4 addr show eth0 | grep inet | awk '{print $2}' | cut -d/ -f1
    ```

<br>

3. 如果想查詢的是 `無線網卡 (wlan0)`，將 `eth0` 更改成 `wlan0` 即可；通常會是連號的 IP，先是有線、再是無線 🛜。

    ```bash
    ip -4 addr show wlan0 | grep inet | awk '{print $2}' | cut -d/ -f1
    ```

<br>

4. 完整查詢；依序會得到 `localhost`、有線網路、無線網路以及虛擬網路接口如 `Docker` 或 `橋接網路` 分配的地址。

    ```bash
    ip -4 addr show | grep inet | awk '{print $2}' | cut -d/ -f1
    ```

    ![](images/img_68.png)

<br>

# 設定固定 IP

_先介紹舊版作業系統的設置方式；特別注意，新版已不再使用 `/etc/dhcpcd.conf` 配置靜態 IP_

<br>

1. 編輯 `/etc/dhcpcd.conf` 文件。

    ```bash
    sudo nano /etc/dhcpcd.conf
    ```

<br>

2. 設定為靜態 IP。

    ```
    interface wlan0
    static ip_address=<更改為-樹莓派-IP>/24
    static routers=192.168.1.254
    static domain_name_servers=8.8.8.8
    ```

<br>

3. 重新啟動網路服務。

    ```
    sudo systemctl restart networking
    ```

<br>

## 設置固定 IP

_新版作業系統使用 `nmcli`，這是 NetworkManager 的命令行工具_

<br>

1. 檢查當前的網路介面名稱，通常是 eth0 或 wlan0。

    ```bash
    nmcli device status
    ```

<br>

2. 將網路介面 `wlan0` 設定為靜態 IP。

    ```bash
    nmcli con modify wlan0 ipv4.addresses <更改為-樹莓派-IP>/24
    nmcli con modify wlan0 ipv4.gateway 192.168.1.254
    nmcli con modify wlan0 ipv4.dns 8.8.8.8,8.8.4.4
    nmcli con modify wlan0 ipv4.method manual
    ```

<br>

3. 重啟網路連線，讓設定生效。

    ```bash
    nmcli con down wlan0 && nmcli con up wlan0
    ```

<br>

## 直接修改設定檔案

1. 列出現有連線檔案。

    ```bash
    ls /etc/NetworkManager/system-connections/
    ```

<br>

2. 輯器修改該檔。

    ```bash
    sudo nano /etc/NetworkManager/system-connections/preconfigured.nmconnection
    ```

<br>

3. 在 `[ipv4]` 區段中，預設為 `method=auto`。

    ![](images/img_69.png)

<br>

4. 修改如下。

    ```bash
    [ipv4]
    method=manual
    addresses=<更改為-樹莓派-IP>/24
    gateway=192.168.1.254
    dns=8.8.8.8;8.8.4.4;
    ```

<br>

5. 儲存、退出並重啟 `NetworkManage`；特別注意，重啟後，原本的終端機畫面會卡住，要另外開啟新的視窗。

    ```bash
    sudo systemctl restart NetworkManager
    ```

<br>

6. 可重新開機確認設置。

    ```bash
    sudo reboot now
    ```

<br>

7. 重啟後檢查 IP；當前因為有線無線皆使用相同 IP，所以會得到與之前不同的結果，這也表示設定生效，若想讓有線和無線網卡擁有不同的固定 IP，可以分別設定不同的靜態 IP。

    ```bash
    ip -4 addr show | grep inet | awk '{print $2}' | cut -d/ -f1
    ```

<br>

## 啟用 cgroups

1. 編輯 `/boot/firmware/cmdline.txt`。

    ```bash
    sudo nano /boot/firmware/cmdline.txt
    ```

<br>

2. 當前設置；特別注意，不可換行，參數以間隔表示。

    ```bash
    console=serial0,115200 console=tty1 root=PARTUUID=9ac2899b-02 rootfstype=ext4 fsck.repair=yes rootwait quiet splash plymouth.ignore-serial-consoles cfg80211.ieee80211_regdom=TW
    ```

<br>

3. 在最右邊加入以下參數；切記，不可斷行。

    ```bash
    cgroup_memory=1 cgroup_enable=memory systemd.unified_cgroup_hierarchy=1
    ```

<br>

4. 接續安裝步驟錢必須重啟系統。

    ```bash
    sudo reboot
    ```

<br>

5. 檢查當前系統使用的 cgroup 版本。

    ```bash
    mount | grep cgroup
    ```

<br>

6. 檢查 cgroup 是否啟用了 memory，memory 的 enabled 應顯示為 1。

    ```bash
    cat /proc/cgroups
    ```

<br>

## 安裝 K3s

1. 執行以下指令安裝 K3s。

    ```bash
    curl -sfL https://get.k3s.io | sh -
    ```

<br>

2. 安裝完成後檢查 K3s 狀態。

    ```bash
    sudo systemctl status k3s
    ```

<br>

3. 查看日誌。

    ```bash
    journalctl -xeu k3s.service
    ```

<br>

4. 確認節點狀態，表示這個節點是 `K3s` 的 `主節點`，將負責管理 Kubernetes 控制平面。

    ```bash
    sudo kubectl get nodes
    ```

<br>

5. 確認節點資源狀態。

    ```bash
    sudo kubectl describe node raspi-2025-blue
    ```

<br>

6. 檢查所有命名空間中的 Pod。

    ```bash
    sudo kubectl get pods -A
    ```

<br>

___

_END_