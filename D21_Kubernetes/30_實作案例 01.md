# 實作案例

_用 k3s 叢集部署 HTML 靜態網頁並用 ngrok 外網訪問_

## 準備工作 

_假設主節點 `192.168.1.125`、工作節點 `192.168.1.157`_

1. 兩台皆預備

```bash
sudo apt update && sudo apt install -y curl
```

2. Docker 可選裝，k3s 內建 containerd，通常不必裝 docker.io



## 關閉 swap、確認 cgroup

1. k3s 可自動判斷，不要求 cgroup 設定這麼嚴格，但建議參考下方方式保證穩定

```bash
sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab
```

## 啟用 memory cgroup

_主、從節點皆要進行該步驟_

1. 編輯

```bash
sudo nano /boot/firmware/cmdline.txt
```

2. 在最尾端加一空格後貼上

```
cgroup_memory=1 cgroup_enable=memory
```

3. 儲存後重新開機

```bash
sudo reboot
```

## 安裝 iptables 工具

_接續前一個步驟，在主、從節點皆進行_

1. 開機後，直接補裝 k3s 依賴；舊版有時是 `iptables-persistent`，新版常見只要裝 `iptables`

```bash
sudo apt update
sudo apt install -y iptables iptables-persistent
```

## 安裝 k3s

_主節點_

1. 若已安裝且因錯誤失敗，先移除殘留再重裝，若第一次沒安裝過會顯示找不到可忽略

```bash
sudo /usr/local/bin/k3s-uninstall.sh
```

2. 執行安裝指令

```bash
curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644
```

3. 驗證

```bash
sudo systemctl status k3s
```

4. 節點

```bash
sudo kubectl get nodes
```

5. 在主節點取得 Join Token 並存入變數，後面步驟要用。

```bash
TOKEN=$(sudo cat /var/lib/rancher/k3s/server/node-token)
echo $TOKEN
```

## 安裝 k3s

_從節點_

1. 先在工作節點上儲存主節點取得的變數

```bash
TOKEN=<貼上輸出>
```

2. 在工作節點上安裝 k3s，這將會自動帶入變數

```bash
curl -sfL https://get.k3s.io | K3S_URL=https://192.168.1.125:6443 K3S_TOKEN=$TOKEN sh -
```

## 驗證叢集

1. 主節點上執行，正確運行時會看到兩台都 `Ready`

```bash
sudo kubectl get nodes
```

## 簡易靜態網頁 Docker 映像檔

1. 安裝 Docker

```bash
sudo apt update
sudo apt install -y docker.io
sudo systemctl enable --now docker
sudo usermod -aG docker $USER
```

2. 登出後重新登入

```bash
exit
```

3. 驗證 Docker 安裝

```bash
docker version
```

4. 先將 DockerHub 帳號存入變數

```bash
_DockerHub=<填入-DockerHub-帳號>
```

2. 在任意主機上製作，這裏在主節點

```bash
mkdir ~/simple-html && cd ~/simple-html
echo '<h1>Hello Raspberry Pi K3s!</h1>' > index.html

# 建立 Dockerfile
cat <<EOF > Dockerfile
FROM nginx:alpine
COPY index.html /usr/share/nginx/html/index.html
EOF

docker build -t $_DockerHub/simple-html:latest .
docker login
docker push $_DockerHub/simple-html:latest
```

## 在 k3s 叢集部署網站

_在主節點_

1. 進入任意目錄後編輯文件

```bash
cd ~/Documents
nano simple-html.yaml
```

2. 填入，其中 `sam6238` 要替換為自己的 DockerHub 帳號

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simple-html
spec:
  replicas: 2
  selector:
    matchLabels:
      app: simple-html
  template:
    metadata:
      labels:
        app: simple-html
    spec:
      containers:
      - name: simple-html
        image: sam6238/simple-html:latest
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: simple-html-service
spec:
  type: NodePort
  selector:
    app: simple-html
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30080
```

3. 部署

```bash
kubectl apply -f simple-html.yaml
```

## 區網測試

1. 在區網內任一台設備訪問以下兩個網址

```bash
http://192.168.1.125:30080
http://192.168.1.157:30080
```

## 外網 ngrok 隧道

1. 儲存 Token

```bash
_Ngrok_Token=<填入-TOKEN>
```

2. 啟動 ngrok

```bash
wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-arm.tgz
tar -xvzf ngrok-v3-stable-linux-arm.tgz
sudo mv ngrok /usr/local/bin
ngrok config add-authtoken $_Ngrok_Token
ngrok http 30080
```

3. 任意外網訪問。

##  節點容錯

_k3s 叢集和 kubeadm 流程一樣，主節點斷線時，已運行服務可由 worker 持續維持，只要服務有多副本、副本有分布在各節點_

1. 進階管理/檢查

```bash
kubectl get nodes
kubectl get pods -A
kubectl describe node <節點名稱>
```

在 樹莓派 k3s 集群 上實現真正的「負載平衡」有幾種常見方法。下面是專為樹莓派等家用/自架場景的實戰做法：



## 1. 使用 k3s 內建 Service LoadBalancer + MetalLB

### 步驟：

1. 安裝 MetalLB（最常用的軟體型 LoadBalancer 實現）：

   ```bash
   kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml
   ```

2. 設定 MetalLB IP 區間（設定你家區網的可用 IP，不要跟現有設備衝突）：

   ```yaml
   # metal-config.yaml 範例
   apiVersion: metallb.io/v1beta1
   kind: IPAddressPool
   metadata:
     name: my-ip-pool
     namespace: metallb-system
   spec:
     addresses:
     - 192.168.1.240-192.168.1.249
   
   apiVersion: metallb.io/v1beta1
   kind: L2Advertisement
   metadata:
     name: my-advertisement
     namespace: metallb-system
   ```

   ```bash
   kubectl apply -f metal-config.yaml
   ```

3. 將你的 Service type 設為 LoadBalancer：

   ```yaml
   # simple-html.yaml 只要改這一段
   kind: Service
   spec:
     type: LoadBalancer   # <- 關鍵
     ports:
       - port: 80
         targetPort: 80
     selector:
       app: simple-html
   ```

   ```bash
   kubectl apply -f simple-html.yaml
   ```

4. 取得服務分配的 LoadBalancer IP：

   ```bash
   kubectl get svc -o wide
   ```

   你會看到有一組「EXTERNAL-IP」是 192.168.1.240\~249 之間的區網 IP。

5. 所有請求會自動被 MetalLB 負載分配到所有可用節點！
   不論你用哪台樹莓派的這個 EXTERNAL-IP 去訪問，K3s 會自動將流量送往叢集中的任一 Pod，達到真正的負載平衡。



## 2. 外部硬體/軟體負載平衡器（補充）

也可架設 Nginx、HAProxy 等作為區網的反向代理，但上述 MetalLB 是最無痛 Kubernetes 方式。



## 3. 注意事項

* 家用區網下，MetalLB 分配的 EXTERNAL-IP 只能在內網用，外網要進來還是要靠 Port Forward 或 NAT 設定（例如你的路由器）。
* MetalLB 不支援雲端自動擴展，但對於家用或測試已經非常夠用。
* 一旦任何節點（Pod）有問題，流量自動分配到其他節點，這才是真正的 K8s/k3s 負載平衡！



## 【總結】

正確做法是在 k3s 上安裝 MetalLB 並將 Service type 設為 LoadBalancer。
區網內直接用 MetalLB 分配的 IP 存取服務，所有流量自動負載平衡到各個可用節點與 Pod。



如需 MetalLB 實際配置檔與範例，可直接告知！
