# éƒ¨ç½² K3s ä¸»ç¯€é»

_å› ç‚º K8s éœ€è¦è€—ç”¨å¤§é‡è³‡æºï¼Œä¸å»ºè­°åœ¨é‚Šç·£è¨­å‚™å¦‚æ¨¹è“æ´¾ä¸Šéƒ¨ç½² K8sï¼Œä»¥ä¸‹å°‡é€²è¡Œ K3s éƒ¨ç½²ã€‚_ 

<br>

## é€£ç·šæ¨¹è“æ´¾

1. é€£æ¥æ¨¹è“æ´¾ã€‚

<br>

2. ç¢ºèªç•¶å‰ IPï¼›ä»¥ä¸‹æŒ‡ä»¤æœƒåšç¯©é¸ï¼Œåƒ…é¡¯ç¤º `æœ‰ç·šç¶²è·¯ eth0` è³‡è¨Šã€‚

    ```bash
    ip -4 addr show eth0 | grep inet | awk '{print $2}' | cut -d/ -f1
    ```

<br>

3. å¦‚æœæƒ³æŸ¥è©¢çš„æ˜¯ `ç„¡ç·šç¶²å¡ (wlan0)`ï¼Œå°‡ `eth0` æ›´æ”¹æˆ `wlan0` å³å¯ï¼›é€šå¸¸æœƒæ˜¯é€£è™Ÿçš„ IPï¼Œå…ˆæ˜¯æœ‰ç·šã€å†æ˜¯ç„¡ç·š ğŸ›œã€‚

    ```bash
    ip -4 addr show wlan0 | grep inet | awk '{print $2}' | cut -d/ -f1
    ```

<br>

4. å®Œæ•´æŸ¥è©¢ï¼›ä¾åºæœƒå¾—åˆ° `localhost`ã€æœ‰ç·šç¶²è·¯ã€ç„¡ç·šç¶²è·¯ï¼›è‹¥æœ‰è™›æ“¬ç¶²è·¯æ¥å£å¦‚ `Docker` æˆ– `æ©‹æ¥ç¶²è·¯` åˆ†é…çš„åœ°å€æœƒæ¥çºŒé¡¯ç¤ºåœ¨å…¶å¾Œã€‚

    ```bash
    ip -4 addr show | grep inet | awk '{print $2}' | cut -d/ -f1
    ```

    ![](images/img_68.png)

<br>

# èˆŠç‰ˆç³»çµ±è¨­å®šå›ºå®š IP

_ç‚ºäº†ç¢ºä¿ `Master ç¯€é»` å’Œ `Worker ç¯€é»` çš„ç¶²è·¯åœ°å€ä¸è®Šï¼Œä»¥ä¸‹å…ˆé€²è¡Œç¯€é»çš„å›ºå®š IP è¨­ç½®ï¼›ç”±æ–¼æ¨¹è“æ´¾æ–°èˆŠç‰ˆæœ¬å°æ–¼ IP è¨­ç½®æ–¹å¼ä¸åŒï¼Œé€™è£¡å…ˆä»‹ç´¹ `èˆŠç‰ˆ` è¨­ç½®æ–¹å¼ï¼›åœ¨æ–°ç‰ˆç³»çµ±ä¸­å·²ä¸å†ä½¿ç”¨ `/etc/dhcpcd.conf` é…ç½®éœæ…‹ IPã€‚_

<br>

1. ç·¨è¼¯ `/etc/dhcpcd.conf` æ–‡ä»¶ã€‚

    ```bash
    sudo nano /etc/dhcpcd.conf
    ```

<br>

2. è¨­å®šç‚ºéœæ…‹ IPã€‚

    ```bash
    interface wlan0
    static ip_address=<æ›´æ”¹ç‚º-æ¨¹è“æ´¾-IP>/24
    static routers=192.168.1.254
    static domain_name_servers=8.8.8.8
    ```

<br>

3. é‡æ–°å•Ÿå‹•ç¶²è·¯æœå‹™ã€‚

    ```bash
    sudo systemctl restart networking
    ```

<br>

## è¨­ç½®å›ºå®š IP

_æ–°ç‰ˆä½œæ¥­ç³»çµ±ä½¿ç”¨ `nmcli` é€²è¡Œè¨­ç½®ï¼Œé€™æ˜¯ `NetworkManager` çš„å‘½ä»¤è¡Œå·¥å…·ã€‚_

<br>

1. æª¢æŸ¥ç•¶å‰çš„ç¶²è·¯ä»‹é¢åç¨±ï¼Œé€šå¸¸æ˜¯ `eth0` æˆ– `wlan0`ï¼›å…¶ä¸­ `lo (loopback)` æ˜¯ `å›ç’°ä»‹é¢`ï¼Œå…§éƒ¨æ¸¬è©¦ç”¨ï¼Œé€šå¸¸ç‚º `127.0.0.1`ï¼›`br` å‰ç¶´æ˜¯æ©‹æ¥ç¶²è·¯ï¼Œ`Wi-Fi P2P` å‰‡æ˜¯é»å°é»ç¶²è·¯ï¼Œç•¶å‰ä¸¦ç„¡ç›¸é—œé€£æ¥ã€‚

    ```bash
    nmcli device status
    ```

    ![](images/img_76.png)

<br>

2. æŸ¥è©¢ä¸¦è¼¸å‡º `wlan0` ä»‹é¢çš„ _é€£ç·šåç¨±_ï¼Œé è¨­æ˜¯ `preconfigured`ï¼ŒåŒæ™‚å­˜å…¥è®Šæ•¸ `CONNECTION_NAME` ä¸­å‚™ç”¨ã€‚

    ```bash
    CONNECTION_NAME=$(nmcli -t -f NAME,DEVICE connection show | grep wlan0 | cut -d: -f1) && echo $CONNECTION_NAME
    ```

<br>

3. æŸ¥è©¢ä¸¦è¼¸å‡ºç•¶å‰ `wlan0` çš„ IP ä¸¦å­˜å…¥è®Šæ•¸ `CURRENT_IP` ä¸­å‚™ç”¨ã€‚

    ```bash
    CURRENT_IP=$(nmcli -t -f IP4.ADDRESS device show wlan0 | cut -d: -f2 | cut -d'/' -f1) && echo $CURRENT_IP
    ```

<br>

4. å¯å…ˆæŸ¥çœ‹é è¨­çš„è¨­å®šæ–‡ä»¶ï¼Œå¯çŸ¥å·²è¨­ç½®äº†ç„¡ç·šç¶²è·¯ `preconfigured.nmconnection`ã€‚

    ```bash
    ls /etc/NetworkManager/system-connections/
    ```

    ![](images/img_79.png)

<br>

5. ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å°‡ç¶²è·¯ä»‹é¢ `wlan0` è¨­å®šç‚ºéœæ…‹ IPï¼Œé€šå¸¸å¯ç›´æ¥ç¶å®šåœ¨ç•¶å‰ç”± DHCP åˆ†é…çš„ IP ä¸Šï¼›é¿å…è®Šæ•¸è§£ææ™‚å‡ºéŒ¯æ‰€ä»¥åŠ ä¸Šå¼•è™Ÿã€‚

    ```bash
    sudo nmcli con modify "$CONNECTION_NAME" ipv4.addresses "$CURRENT_IP"/24
    sudo nmcli con modify "$CONNECTION_NAME" ipv4.gateway 192.168.1.254
    sudo nmcli con modify "$CONNECTION_NAME" ipv4.dns 8.8.8.8,8.8.4.4
    sudo nmcli con modify "$CONNECTION_NAME" ipv4.method manual
    ```

<br>

6. è¨­ç½®å®Œæˆå¾ŒæŸ¥çœ‹å…§å®¹ã€‚

    ```bash
    sudo cat "/etc/NetworkManager/system-connections/$CONNECTION_NAME.nmconnection"
    ```

    ![](images/img_80.png)

<br>

7. ä¹Ÿå¯ä½¿ç”¨ `grep` æŒ‡ä»¤ç¯©é¸ `ipv4` ç›¸é—œè¨­å®šä¸¦é¡¯ç¤ºæ–¼ç•«é¢ã€‚

    ```bash
    sudo cat "/etc/NetworkManager/system-connections/$CONNECTION_NAME.nmconnection" | grep -A5 '\[ipv4\]'
    ```

<br>

## å¥—ç”¨è®Šæ›´

_å¯ä»¥é‡å•Ÿé€£ç·šæˆ–é‡å•Ÿæœå‹™_

<br>

1. é‡å•Ÿç¶²è·¯é€£ç·šï¼Œè®“è¨­å®šç”Ÿæ•ˆã€‚

    ```bash
    sudo nmcli con down "$CONNECTION_NAME" && sudo nmcli con up "$CONNECTION_NAME"
    ```

    ![](images/img_77.png)

<br>

2. ä¹Ÿå¯ä»¥é‡å•Ÿæœå‹™ã€‚

    ```bash
    sudo systemctl restart NetworkManager
    ```

<br>

## æª¢æŸ¥

1. æŸ¥çœ‹ç•¶å‰ `default route` è¨­å®šï¼›Linux æœƒé¸æ“‡ metric è¼ƒä½è€…ä½œç‚ºé è¨­è·¯ç”±ã€‚

    ```bash
    ip route show
    ```

    ![](images/img_81.png)

<br>

2. ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å¯åˆªé™¤æŒ‡å®šçš„è·¯ç”±ã€‚

    ```bash
    sudo ip route del <è¤‡è£½æŸ¥è©¢å…§å®¹é€²è¡Œåˆªé™¤>
    ```

<br>

3. ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å¯ä¿®æ”¹è·¯ç”±å„ªå…ˆæ¬Šï¼›ç‰¹åˆ¥æ³¨æ„ï¼Œé€™å¯èƒ½æœƒé€ æˆç„¡æ³•é€£ç·šå•é¡Œï¼Œå‡ºç¾å•é¡Œå¯æ¢å¾©åŸå€¼ã€‚

    ```bash
    sudo nmcli con modify "preconfigured" ipv4.route-metric 50
    ```

<br>

4. è¨­å®š `metric` ä¹‹å¾Œï¼Œéœ€é‡å•Ÿè©²é€£ç·šå¥—ç”¨è®Šæ›´ã€‚

    ```bash
    sudo nmcli con down "preconfigured" && sudo nmcli con up "preconfigured"
    ```

<br>

5. å˜—è©¦å®‰è£å¥—ä»¶ `dnsutils` ä»¥è§€å¯Ÿç¶²è·¯ç‹€æ…‹æ˜¯å¦æ­£å¸¸ã€‚

    ```bash
    sudo apt update && sudo apt install -y dnsutils
    ```

<br>

6. å†æ¬¡æŸ¥çœ‹ç•¶å‰ `default route` è¨­å®šï¼›è‹¥è¦é‡è¨­å›åŸæœ¬å…§å®¹å‰‡é‡è¤‡ä»¥ä¸Šæ­¥é©Ÿã€‚

    ```bash
    ip route show
    ```

<br>

7. æŸ¥è©¢ DNS è§£æçµæœï¼Œé¡¯ç¤º `get.k3s.io` å°æ‡‰çš„ IP åœ°å€ï¼›é€™æ˜¯è¼ƒèˆŠçš„å·¥å…·ã€‚

    ```bash
    nslookup get.k3s.io
    ```

<br>

7. æŸ¥è©¢ DNS è§£æè©³ç´°è³‡è¨Šï¼ŒåŒ…æ‹¬ `ä¼ºæœå™¨å›æ‡‰ã€æŸ¥è©¢æ™‚é–“ã€TTL` ç­‰ï¼›é€™æ˜¯è¼ƒæ–°çš„å·¥å…·ã€‚

    ```bash
    dig get.k3s.io
    ```

<br>

## ç›´æ¥ç·¨è¼¯è¨­å®šæ–‡ä»¶

_ä»¥ä¸‹ç›´æ¥ç·¨è¼¯è¨­å®šæ–‡ä»¶è¨­å®šç„¡ç·šç¶²è·¯å›ºå®š IP_

<br>

1. åˆ—å‡ºç¾æœ‰é€£ç·šæª”æ¡ˆï¼Œå…¶ä¸­ `preconfigured.nmconnection` æ§åˆ¶ç„¡ç·šç¶²è·¯ï¼›`Wired connection 1.nmconnection` æ§åˆ¶æœ‰ç·šç¶²è·¯ï¼Œç”± `NetworkManager` å»ºç«‹ã€‚

    ```bash
    ls /etc/NetworkManager/system-connections/
    ```

    ![](images/img_78.png)

<br>

2. æŸ¥è©¢ç•¶å‰é…ç™¼çš„ç„¡ç·šç¶²è·¯ IPã€‚

    ```bash
    ip -4 addr show wlan0 | grep inet | awk '{print $2}' | cut -d/ -f1
    ```

<br>

3. è¼¯å™¨ä¿®æ”¹è©²æª”ï¼Œä¾æ“šæŸ¥è©¢çµæœå¡«å…¥ IPã€‚

    ```bash
    sudo nano /etc/NetworkManager/system-connections/preconfigured.nmconnection
    ```

<br>

4. åœ¨ `[ipv4]` å€æ®µä¸­ï¼Œé è¨­ç‚º `method=auto`ã€‚

    ![](images/img_69.png)

<br>

5. å°‡æ–¹æ³•æ”¹ç‚º `manual`ï¼Œè©³ç´°å…§å®¹å¦‚ä¸‹ï¼›ç‰¹åˆ¥æ³¨æ„ï¼Œå¤šå€‹ DNS ä¼ºæœå™¨éœ€ç”¨ `åˆ†è™Ÿ (;)` åˆ†éš”ï¼Œå»ºè­°å°¾ç«¯ä¹ŸåŠ ä¸Šåˆ†è™Ÿï¼Œå¦å‰‡å¯èƒ½è§£æå¤±æ•—ã€‚

    ```bash
    [ipv4]
    method=manual
    addresses=<æ›´æ”¹ç‚º-æ¨¹è“æ´¾-IP>/24
    gateway=192.168.1.254
    dns=8.8.8.8;8.8.4.4;
    ```

<br>

6. å„²å­˜ã€é€€å‡ºä¸¦é‡å•Ÿ `NetworkManage`ï¼›ç‰¹åˆ¥æ³¨æ„ï¼Œé‡å•Ÿå¾Œï¼ŒåŸæœ¬çš„çµ‚ç«¯æ©Ÿç•«é¢æœƒæš«æ™‚å¡ä½ï¼Œéœ€ç¨ä½œç­‰å¾…é‡å•Ÿã€‚

    ```bash
    sudo systemctl restart NetworkManager
    ```

<br>

7. æª¢æŸ¥ IPã€‚

    ```bash
    ip -4 addr show | grep inet | awk '{print $2}' | cut -d/ -f1
    ```

<br>

## è¨­ç½® cgroups

_æ˜¯ Linux æ ¸å¿ƒçš„ä¸€å€‹åŠŸèƒ½ï¼Œä¸»è¦ç”¨æ–¼ç®¡ç†å’Œé™åˆ¶ç³»çµ±è³‡æºçš„ä½¿ç”¨ï¼›åœ¨ K8s / K3s ä¸­ç”¨ä¾†ç®¡ç† Pod å’Œå®¹å™¨çš„è³‡æºé…é¡ã€‚_

<br>

1. ç·¨è¼¯ `/boot/firmware/cmdline.txt`ã€‚

    ```bash
    sudo nano /boot/firmware/cmdline.txt
    ```

<br>

2. ç•¶å‰è¨­ç½®å¦‚ä¸‹ï¼›ç‰¹åˆ¥æ³¨æ„ï¼Œé€™å€‹è¨­å®šæ˜¯å–®è¡Œè¡¨ç¤ºã€ä¸å¯æ›è¡Œçš„ï¼Œåƒæ•¸ä»¥é–“éš”è¡¨ç¤ºã€‚

    ```bash
    console=serial0,115200 console=tty1 root=PARTUUID=9ac2899b-02 rootfstype=ext4 fsck.repair=yes rootwait quiet splash plymouth.ignore-serial-consoles cfg80211.ieee80211_regdom=TW
    ```

<br>

3. åœ¨æœ€å³é‚Šç©ºä¸€æ ¼ä¹‹å¾ŒåŠ å…¥ä»¥ä¸‹åƒæ•¸ã€‚

    ```bash
    cgroup_memory=1 cgroup_enable=memory systemd.unified_cgroup_hierarchy=1
    ```

<br>

4. å¯å…ˆæŸ¥çœ‹è¨­å®šå…§å®¹ã€‚

    ```bash
    cat /boot/firmware/cmdline.txt
    ```

<br>

## æª¢æŸ¥ `cgroup` ç‹€æ…‹

1. æ¥çºŒå®‰è£æ­¥é©Ÿå‰å…ˆé‡å•Ÿç³»çµ±ã€‚

    ```bash
    sudo reboot now
    ```

<br>

2. æª¢æŸ¥ç•¶å‰ç³»çµ±ä½¿ç”¨çš„ `cgroup` ç‰ˆæœ¬ã€‚

    ```bash
    mount | grep cgroup
    ```

<br>

3. æª¢æŸ¥ `cgroup` æ˜¯å¦å•Ÿç”¨äº† `memory`ï¼Œ`memory` çš„ `enabled` æ‡‰é¡¯ç¤ºç‚º `1`ã€‚

    ```bash
    cat /proc/cgroups
    ```

<br>

## å®‰è£ K3s

1. åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤å®‰è£ K3sã€‚

    ```bash
    curl -sfL https://get.k3s.io | sudo sh -
    ```

<br>

2. å®‰è£å®Œæˆå¾Œæª¢æŸ¥ K3s ç‹€æ…‹ï¼›å‹™å¿…ç¢ºèªç‹€æ…‹ç‚º `active`ã€‚

    ```bash
    sudo systemctl status k3s
    ```

<br>

3. æŸ¥çœ‹æ—¥èªŒï¼›åƒæ•¸ `-n` è¡¨ç¤ºé¡¯ç¤ºçš„è³‡æ–™ç­†æ•¸ã€‚

    ```bash
    journalctl -xeu k3s.service -n 30
    ```

<br>

4. ç¢ºèªç¯€é»ç‹€æ…‹ï¼Œ`master` è¡¨ç¤ºé€™å€‹ç¯€é»æ˜¯ `K3s` çš„ `ä¸»ç¯€é»`ï¼Œå°‡è² è²¬ç®¡ç† Kubernetes æ§åˆ¶å¹³é¢ã€‚

    ```bash
    sudo kubectl get nodes
    ```

<br>

5. ä½¿ç”¨ `awk` ç¯©é¸ç¯€é»åç¨±ï¼›`NR==2` è¡¨ç¤ºå– `ç¬¬äºŒè¡Œ`ï¼Œç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œï¼Œ`{print $1}` å–å‡ºè©²è¡Œçš„ç¬¬ä¸€æ¬„ `NAME`ã€‚

    ```bash
    NODE_NAME=$(sudo kubectl get nodes | awk 'NR==2 {print $1}')
    echo $NODE_NAME
    ```

<br>

6. ç¢ºèªç¯€é»è³‡æºç‹€æ…‹ï¼›å¸¶å…¥å‰ä¸€å€‹æ­¥é©Ÿå–å¾—çš„åç¨±è®Šæ•¸ `NODE_NAME`ã€‚

    ```bash
    sudo kubectl describe node $NODE_NAME
    ```

<br>

6. æª¢æŸ¥æ‰€æœ‰å‘½åç©ºé–“ä¸­çš„ `Pod`ã€‚

    ```bash
    sudo kubectl get pods -A
    ```

    ![](images/img_82.png)

<br>

## K3s é è¨­ Pod èªªæ˜

1. `coredns-ccb96694c-jmh2n`ï¼ŒCoreDNS æ˜¯ Kubernetes å…§å»ºçš„ DNS æœå‹™ï¼Œç”¨æ–¼è§£æ Pod åŠ Service åç¨±ã€‚

<br>

2. `helm-install-traefik-crd-hk6gg`ï¼ŒHelm å®‰è£ Traefik CRDï¼ŒTraefik æ˜¯ K3s é è¨­çš„ Ingress Controllerï¼Œé€™å€‹ Pod ç”¨æ–¼å®‰è£ Custom Resource Definitions (CRD)ã€‚

<br>

3. `helm-install-traefik-hd6kh`ï¼ŒHelm å®‰è£ Traefikï¼Œè² è²¬éƒ¨ç½² Traefik Ingress Controllerã€‚

<br>

4. `local-path-provisioner-5cf85fd84d-gmrxp`ï¼Œæœ¬åœ°å­˜å„²ä¾›æ‡‰å™¨ï¼Œç”¨æ–¼å‹•æ…‹é…ç½® PVCï¼ˆPersistent Volume Claimsï¼‰ï¼Œå…è¨± Pod ä½¿ç”¨æœ¬æ©Ÿå­˜å„²ã€‚

<br>

5. `metrics-server-5985cbc9d7-bs25r`ï¼ŒMetrics Serverï¼Œæä¾› Kubernetes ç›£æ§æ•¸æ“šï¼Œå¦‚ CPU å’Œè¨˜æ†¶é«”ä½¿ç”¨ç‡ï¼Œæ”¯æ´ kubectl top æŒ‡ä»¤ã€‚

<br>

6. `svclb-traefik-87972c75-jgpjc`ï¼ŒTraefik æœå‹™è² è¼‰å‡è¡¡å™¨ï¼Œç”¨ä¾†å°‡å¤–éƒ¨è«‹æ±‚è½‰ç™¼åˆ° Kubernetes å…§éƒ¨çš„ Traefik Ingress Controllerã€‚

<br>

7. `traefik-5d45fc8cc9-wtg9c`ï¼ŒTraefik Ingress Controllerï¼Œè² è²¬è™•ç† HTTP / HTTPS é€²å…¥ Kubernetes å¢é›†çš„æµé‡ã€‚

<br>

___

_END_