# 快速導覽

_參考 [網路文章](https://everythingdevops.dev/step-by-step-guide-creating-a-kubernetes-cluster-on-raspberry-pi-5-with-k3s/)，在 `樹莓派 5` 使用 `K3s` 建立 `Kubernetes 叢集`_


## 關於 K3s

1. `K3s` 是針對資源受限環境如 _IoT 設備或邊緣運算設備_ 設計的輕量版 `Kubernetes`，並已針對 `ARM 架構` 進行優化，適用於樹莓派。

2. 輕量化設計佔用資源較少，同時簡化安裝程序，比傳統 Kubernetes 更簡單，另外也內建 `kubectl`，可直接使用 `kubectl` 指令。


## 連線樹莓派

1. 透過 SSH 連接樹莓派

```
ssh pi@<hostname>.local
```

2. 確認當前 IP；僅顯示有線網路。

```bash
ip -4 addr show eth0 | grep inet | awk '{print $2}' | cut -d/ -f1
```

3. 如果是 `無線網卡 (wlan0)`，將 `eth0` 替換成 `wlan0`。

```bash
ip -4 addr show wlan0 | grep inet | awk '{print $2}' | cut -d/ -f1
```

4. 完整查詢；依序會得到 `localhost`、有線網路、無線網路以及虛擬網路接口如 `Docker` 或 `橋接網路` 分配的地址。

```bash
ip -4 addr show | grep inet | awk '{print $2}' | cut -d/ -f1
```

![](images/img_68.png)

# 設定固定 IP

_先介紹舊版作業系統的設置方式；特別注意，新版已不再使用 `/etc/dhcpcd.conf` 配置靜態 IP_

1. 編輯 `/etc/dhcpcd.conf` 文件，

```bash
sudo nano /etc/dhcpcd.conf
```

2. 設定為靜態 IP。

```
interface wlan0
static ip_address=<替換為-樹莓派-IP>/24
static routers=192.168.1.254
static domain_name_servers=8.8.8.8
```

3. 重新啟動網路服務

```
sudo systemctl restart networking
```

## 設置固定 IP

_新版作業系統使用 `nmcli`，這是 NetworkManager 的命令行工具_

1. 檢查當前的網路介面名稱，通常是 eth0 或 wlan0。

```bash
nmcli device status
```

2. 將網路介面 `wlan0` 設定為靜態 IP

```bash
nmcli con modify wlan0 ipv4.addresses <替換為-樹莓派-IP>/24
nmcli con modify wlan0 ipv4.gateway 192.168.1.254
nmcli con modify wlan0 ipv4.dns 8.8.8.8,8.8.4.4
nmcli con modify wlan0 ipv4.method manual
```

3. 重啟網路連線，讓設定生效

```bash
nmcli con down wlan0 && nmcli con up wlan0
```

## 直接修改設定檔案

1. 列出現有連線檔案

```bash
ls /etc/NetworkManager/system-connections/
```

2. 輯器修改該檔

```bash
sudo nano /etc/NetworkManager/system-connections/preconfigured.nmconnection
```

3. 在 `[ipv4]` 區段中，預設為 `method=auto`。

![](images/img_69.png)

4. 修改如下。

```bash
[ipv4]
method=manual
addresses=<替換為-樹莓派-IP>/24
gateway=192.168.1.254
dns=8.8.8.8;8.8.4.4;
```

5. 儲存、退出並重啟 `NetworkManage`；特別注意，重啟後，原本的終端機畫面會卡住，要另外開啟新的視窗。

```bash
sudo systemctl restart NetworkManager
```

6. 可重新開機確認設置。

```bash
sudo reboot now
```

7. 重啟後檢查 IP；當前因為有線無線皆使用相同 IP，所以會得到與之前不同的結果，這也表示設定生效，若想讓有線和無線網卡擁有不同的固定 IP，可以分別設定不同的靜態 IP。

```bash
ip -4 addr show | grep inet | awk '{print $2}' | cut -d/ -f1
```

## 啟用 cgroups

1. 編輯 `/boot/firmware/cmdline.txt`，

```bash
sudo nano /boot/firmware/cmdline.txt
```

2. 當前設置；特別注意，不可換行，參數以間隔表示。

```bash
console=serial0,115200 console=tty1 root=PARTUUID=9ac2899b-02 rootfstype=ext4 fsck.repair=yes rootwait quiet splash plymouth.ignore-serial-consoles cfg80211.ieee80211_regdom=TW
```

3. 在最右邊加入以下參數；切記，不可斷行。

```bash
cgroup_memory=1 cgroup_enable=memory systemd.unified_cgroup_hierarchy=1
```

4. 接續安裝步驟錢必須重啟系統。

```bash
sudo reboot
```

5. 檢查當前系統使用的 cgroup 版本

```bash
mount | grep cgroup
```

6. 檢查 cgroup 是否啟用了 memory，memory 的 enabled 應顯示為 1。

```bash
cat /proc/cgroups
```


## 安裝 K3s

1. 執行以下指令安裝 K3s

```bash
curl -sfL https://get.k3s.io | sh -
```

2. 安裝完成後檢查 K3s 狀態

```bash
sudo systemctl status k3s
```

3. 查看日誌

```bash
journalctl -xeu k3s.service
```

4. 確認節點狀態，表示這個節點是 `K3s` 的 `主節點`，將負責管理 Kubernetes 控制平面。

```bash
sudo kubectl get nodes
```

5. 確認節點資源狀態

```bash
sudo kubectl describe node raspi-2025-blue
```

6. 檢查所有命名空間中的 Pod

```bash
sudo kubectl get pods -A
```



