# 加入 K3s 叢集

_將其他樹莓派設備加入叢集_

## 準備工作

1. 系統設定

```bash
sudo apt update && sudo apt upgrade -y
```

2. 安裝必要工具

```bash
sudo apt install -y curl iptables
```

3. 啟用 cgroup 支援，確保工作節都啟用了 `cgroup_memory` 和 `systemd.unified_cgroup_hierarchy=1`

```bash
sudo nano /boot/firmware/cmdline.txt
```

4. 加入參數

```bash
cgroup_memory=1 cgroup_enable=memory systemd.unified_cgroup_hierarchy=1
```

5. 儲存並重啟

```bash
sudo reboot
```

## 加入工作節點
在準備好的樹莓派上安裝 K3s Agent，執行以下指令：

1. 安裝 K3s Agent
   ```bash
   curl -sfL https://get.k3s.io | K3S_URL=https://192.168.1.125:6443 K3S_TOKEN=<你的 Master Node TOKEN> sh -
   ```

   - `K3S_URL`：Master Node 的 API 地址（在此例中為 `https://192.168.1.125:6443`）。  
   - `K3S_TOKEN`：從 Master Node 獲得的 Token（`sudo cat /var/lib/rancher/k3s/server/node-token`）。

2. 檢查安裝日誌
   確保 Agent 正常啟動並連接到 Master Node：
   ```bash
   sudo journalctl -u k3s-agent -f
   ```



### 步驟 3：確認工作節點狀態
在 Master Node 上執行以下命令，確認新節點已成功加入：
```bash
sudo kubectl get nodes
```
如果節點顯示 `Ready`，則表示工作節點已成功加入叢集。



### 步驟 4：測試工作節點的功能
部署測試應用，確認 Pod 可以分配到新加入的工作節點上：
```bash
kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get pods -o wide
```



### 後續建議
- 自動化這些準備步驟（我可以幫你撰寫安裝腳本，讓每台樹莓派自動完成環境配置）。  
- 監控叢集狀態，使用 Prometheus 和 Grafana 進行資源使用分析。  
- 擴展工作節點數量，根據應用負載需求靈活擴充叢集。

如果你想要腳本化自動配置，請隨時告訴我！ 😊